<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='(Feature image credits: GS big picture, please say thanks to GS.#419 - yuedajiong)
gaussian-splatting python Source code
Define Params (2024-01-22)
Create PyTorch tensors for Gaussians&amp;rsquo; parameters at GaussianModel() by __init__ them with torch.empty(0):
_xyz (Gaussian center), _features_dc and _features_rest (SH coeffs), _scaling (vec3), _rotation(quaternion), sh_degree (color), _opacity (unweighted alpha)
Each covariance matrix 𝚺 is built from a scaling vector and a quaternion:
s q c u a a l t i e n r g n i v o e n c S R t o r t e a c t h i i o n n g m m a a t t r r i i x x 𝐑 𝐒 ↗ ↘ 𝚺 = 𝐑 𝐒 𝐒 ᵀ 𝐑 ᵀ t l r o i w a e n r g ?'>
<title>read: 3DGS | Code Understanding</title>

<link rel='canonical' href='https://zichen34.github.io/writenotes/model/splat/b-note-3dgs-code/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='read: 3DGS | Code Understanding'>
<meta property='og:description' content='(Feature image credits: GS big picture, please say thanks to GS.#419 - yuedajiong)
gaussian-splatting python Source code
Define Params (2024-01-22)
Create PyTorch tensors for Gaussians&amp;rsquo; parameters at GaussianModel() by __init__ them with torch.empty(0):
_xyz (Gaussian center), _features_dc and _features_rest (SH coeffs), _scaling (vec3), _rotation(quaternion), sh_degree (color), _opacity (unweighted alpha)
Each covariance matrix 𝚺 is built from a scaling vector and a quaternion:
s q c u a a l t i e n r g n i v o e n c S R t o r t e a c t h i i o n n g m m a a t t r r i i x x 𝐑 𝐒 ↗ ↘ 𝚺 = 𝐑 𝐒 𝐒 ᵀ 𝐑 ᵀ t l r o i w a e n r g ?'>
<meta property='og:url' content='https://zichen34.github.io/writenotes/model/splat/b-note-3dgs-code/'>
<meta property='og:site_name' content='Zichen Wang'>
<meta property='og:type' content='article'><meta property='article:section' content='WriteNotes' /><meta property='article:tag' content='Splatting' /><meta property='article:published_time' content='2024-01-22T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-01-22T00:00:00&#43;00:00'/><meta property='og:image' content='https://user-images.githubusercontent.com/52232153/283030293-f9f3589c-fa59-431f-8bd0-478337426933.png' />
<meta name="twitter:title" content="read: 3DGS | Code Understanding">
<meta name="twitter:description" content="(Feature image credits: GS big picture, please say thanks to GS.#419 - yuedajiong)
gaussian-splatting python Source code
Define Params (2024-01-22)
Create PyTorch tensors for Gaussians&amp;rsquo; parameters at GaussianModel() by __init__ them with torch.empty(0):
_xyz (Gaussian center), _features_dc and _features_rest (SH coeffs), _scaling (vec3), _rotation(quaternion), sh_degree (color), _opacity (unweighted alpha)
Each covariance matrix 𝚺 is built from a scaling vector and a quaternion:
s q c u a a l t i e n r g n i v o e n c S R t o r t e a c t h i i o n n g m m a a t t r r i i x x 𝐑 𝐒 ↗ ↘ 𝚺 = 𝐑 𝐒 𝐒 ᵀ 𝐑 ᵀ t l r o i w a e n r g ?"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://user-images.githubusercontent.com/52232153/283030293-f9f3589c-fa59-431f-8bd0-478337426933.png' />
    <link rel="shortcut icon" href="/favicon-32x32.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu238e2fe759432347fa5dd53661ac4381_131637_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Zichen Wang</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/zichen34'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/luckily1640'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/aboutme/' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/writenotes/' >
                
                
                
                <span>WriteNotes</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#gaussian-splatting-python">gaussian-splatting python</a>
      <ol>
        <li><a href="#define-params">Define Params</a></li>
        <li><a href="#render">Render</a></li>
      </ol>
    </li>
    <li><a href="#diff_gauss_raster">diff_gauss_raster</a>
      <ol>
        <li><a href="#python-invokes">Python Invokes</a></li>
        <li><a href="#forward-steps">forward Steps</a></li>
        <li><a href="#preprocesscuda">preprocessCUDA</a></li>
        <li><a href="#prepare-tiles">Prepare Tiles</a></li>
        <li><a href="#render-pixel">Render Pixel</a></li>
      </ol>
    </li>
    <li><a href="#backward">Backward</a>
      <ol>
        <li><a href="#back-render">back render</a></li>
        <li><a href="#bw-cov2d">bw cov2D</a>
          <ol>
            <li><a href="#dσdσ">dΣ&rsquo;⁻¹/dΣ'</a></li>
            <li><a href="#dσdσ-1">dΣ&rsquo;/dΣ</a></li>
            <li><a href="#dσdt">dΣ&rsquo;/dT</a></li>
            <li><a href="#dtdj">dT/dJ</a></li>
            <li><a href="#djdt">dJ/dt</a></li>
            <li><a href="#dtdx">dt/dx</a></li>
          </ol>
        </li>
        <li><a href="#bw-preprocess">bw preprocess</a>
          <ol>
            <li><a href="#d_pixd_world">d_pix/d_world</a></li>
            <li><a href="#d_rgbd_sh">d_RGB/d_SH</a></li>
            <li><a href="#d_cov3dd_m">d_cov3D/d_M</a></li>
            <li><a href="#dmds">dM/ds</a></li>
            <li><a href="#dmdq">dM/dq</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/writenotes/model/splat/b-note-3dgs-code/">
                
                    <img src="https://user-images.githubusercontent.com/52232153/283030293-f9f3589c-fa59-431f-8bd0-478337426933.png" loading="lazy" alt="Featured image of post read: 3DGS | Code Understanding" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/writenotes/model/splat/b-note-3dgs-code/">read: 3DGS | Code Understanding</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 22, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    43 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>(Feature image credits: <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/issues/419"  target="_blank" rel="noopener"
    >GS big picture, please say thanks to GS.#419 - yuedajiong</a>)</p>
<h2 id="gaussian-splatting-python">gaussian-splatting python</h2>
<p><a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting"  target="_blank" rel="noopener"
    >Source code</a></p>
<h3 id="define-params">Define Params</h3>
<p>(2024-01-22)</p>
<ol>
<li>
<p>Create PyTorch tensors for Gaussians&rsquo; parameters at <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/train.py#L34"  target="_blank" rel="noopener"
    ><code>GaussianModel()</code></a>
by <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/gaussian_model.py#L44"  target="_blank" rel="noopener"
    ><code>__init__</code></a> them with <code>torch.empty(0)</code>:</p>
<ul>
<li>
<p><code>_xyz</code> (Gaussian center), <code>_features_dc</code> and <code>_features_rest</code> (SH coeffs),
<code>_scaling</code> (vec3), <code>_rotation</code>(quaternion), <code>sh_degree</code> (color), <code>_opacity</code> (unweighted alpha)</p>
</li>
<li>
<p>Each covariance matrix 𝚺 is built from a scaling vector and a quaternion:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 496 57"
      >
      <g transform='translate(8,16)'>
<path d='M 96,0 L 104,0' fill='none' stroke='currentColor'></path>
<path d='M 344,16 L 352,16' fill='none' stroke='currentColor'></path>
<path d='M 96,32 L 104,32' fill='none' stroke='currentColor'></path>
<polygon points='112.000000,0.000000 100.000000,-5.600000 100.000000,5.600000' fill='currentColor' transform='rotate(0.000000, 104.000000, 0.000000)'></polygon>
<polygon points='112.000000,32.000000 100.000000,26.400000 100.000000,37.599998' fill='currentColor' transform='rotate(0.000000, 104.000000, 32.000000)'></polygon>
<polygon points='360.000000,16.000000 348.000000,10.400000 348.000000,21.600000' fill='currentColor' transform='rotate(0.000000, 352.000000, 16.000000)'></polygon>
<text text-anchor='middle' x='0' y='4' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='0' y='36' fill='currentColor' style='font-size:1em'>q</text>
<text text-anchor='middle' x='8' y='4' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='8' y='36' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='16' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='16' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='24' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='24' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='32' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='40' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='48' y='4' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='36' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='64' y='4' fill='currentColor' style='font-size:1em'>v</text>
<text text-anchor='middle' x='64' y='36' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='72' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>S</text>
<text text-anchor='middle' x='120' y='36' fill='currentColor' style='font-size:1em'>R</text>
<text text-anchor='middle' x='128' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='128' y='36' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='136' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='136' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='144' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='144' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='152' y='4' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='152' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='160' y='36' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='168' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='168' y='36' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='176' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='176' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='4' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='192' y='36' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='200' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='224' y='36' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='232' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='232' y='36' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='240' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='248' y='36' fill='currentColor' style='font-size:1em'>𝐑</text>
<text text-anchor='middle' x='256' y='4' fill='currentColor' style='font-size:1em'>𝐒</text>
<text text-anchor='middle' x='264' y='36' fill='currentColor' style='font-size:1em'>↗</text>
<text text-anchor='middle' x='272' y='4' fill='currentColor' style='font-size:1em'>↘</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>𝚺</text>
<text text-anchor='middle' x='280' y='20' fill='currentColor' style='font-size:1em'>=</text>
<text text-anchor='middle' x='288' y='20' fill='currentColor' style='font-size:1em'>𝐑</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>𝐒</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>𝐒</text>
<text text-anchor='middle' x='312' y='20' fill='currentColor' style='font-size:1em'>ᵀ</text>
<text text-anchor='middle' x='320' y='20' fill='currentColor' style='font-size:1em'>𝐑</text>
<text text-anchor='middle' x='328' y='20' fill='currentColor' style='font-size:1em'>ᵀ</text>
<text text-anchor='middle' x='368' y='20' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='376' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='376' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='384' y='4' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='384' y='20' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='392' y='4' fill='currentColor' style='font-size:1em'>w</text>
<text text-anchor='middle' x='392' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='400' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='400' y='20' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='408' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='408' y='20' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='416' y='4' fill='currentColor' style='font-size:1em'>?</text>
<text text-anchor='middle' x='416' y='20' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='424' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='440' y='20' fill='currentColor' style='font-size:1em'>`</text>
<text text-anchor='middle' x='448' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='456' y='20' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='464' y='20' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='472' y='20' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='480' y='20' fill='currentColor' style='font-size:1em'>`</text>
</g>

    </svg>
  
</div>
<p><code>symm</code> is [Σ₀₀, Σ₀₁, Σ₀₂, Σ₁₁, Σ₁₂, Σ₂₂]</p>
</li>
</ul>
</li>
<li>
<p>Read point cloud and cameras at <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/train.py#L35"  target="_blank" rel="noopener"
    ><code>Scene()</code></a>
by calling <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/__init__.py#L25"  target="_blank" rel="noopener"
    ><code>__init__</code></a></p>
<ul>
<li>
<p>SceneInfo:</p>
<ul>
<li>
<p>Basic point cloud: <code>points</code>(x,y,z), <code>normals</code> (nx,ny,nz), <code>colors</code> (r,g,b)</p>
</li>
<li>
<p>CameraInfo: extrinsics (<code>R</code>,<code>T</code>), fov (<code>FovX</code>,<code>FovY</code>), gt images (<code>image</code>, <code>image_name</code>, <code>image_path</code>, <code>width</code>, <code>height</code>)</p>
</li>
<li>
<p><code>nerf_normalization</code> (avg_cam_center (<code>translate</code>), max displacement from the avg cam (<code>radius</code>)),</p>
</li>
</ul>
</li>
<li>
<p>Cameras list <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/__init__.py#L73"  target="_blank" rel="noopener"
    ><code>train_cameras</code></a> of 300 <code>Camera()</code>
is made up by repeatly <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/utils/camera_utils.py#L58"  target="_blank" rel="noopener"
    ><code>loadCam()</code></a></p>
<ul>
<li>
<p>Resize GT image for each camera (i.e., 300 views).</p>
</li>
<li>
<p>Viewing transform (world➡camera): <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/cameras.py#L54"  target="_blank" rel="noopener"
    ><code>self.world_view_transform</code></a></p>
</li>
<li>
<p>Projection matrix (camera➡clip): <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/utils/graphics_utils.py#L51"  target="_blank" rel="noopener"
    ><code>self.projection_matrix</code></a></p>
<p>$$
𝐏 = \begin{bmatrix}
\frac{2n}{r-l} &amp; 0 &amp; \frac{r+l}{r-l} &amp; 0 \\
0 &amp; \frac{2n}{t-b} &amp; \frac{t+b}{t-b} &amp; 0 \\
0 &amp; 0 &amp; \frac{f}{f-n} &amp; \frac{-fn}{f-n} \\
0 &amp; 0 &amp; 1 &amp; 0
\end{bmatrix}
$$</p>
<p>By denoting sight width as $W$, the above $r=\frac{W}{2},\ l=-\frac{W}{2}$, so $(r-l)=W$.
The sight center (principle center) (cx,cy) is (r,l), i.e., (W/2, H/2)
The clip coordinate of $x$ produced by multiplying 𝐏 will result in $x_{NDC} ∈ [-1,1]$</p>
<p>By using this 𝐏, the final $z$ axis of ND coordinate ranges in [0,1], unlike the usual NDC cube of [-1,1]</p>
<p>$$
near_{NDC} = \frac{ \frac{f * near}{f-n} + \frac{-fn}{f-n} }{n} = 0 \\
far_{NDC} = \frac{ \frac{f*far}{f-n} + \frac{-fn}{f-n} }{f} = 1
$$</p>
<p>Therefore, this 𝐏 leads to a <strong>cuboid</strong> NDC space, rather than a cube NDC space.
Figuratively, in the clip space, the points satisfying $0&lt;z_{clip} &lt; w_{clip}$ and $-w_{clip} &lt; x_{clip}, y_{clip} &lt; w_{clip}$
will be excluded from rendering.
After clipping those point, the remaining space is the NDC space.</p>
</li>
<li>
<p>The transformation from world to clip space (P@w2c)ᵀ for each camera: <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/cameras.py#L56"  target="_blank" rel="noopener"
    ><code>self.full_proj_transform</code></a></p>
</li>
</ul>
</li>
<li>
<p>Initialize Gaussians&rsquo; parameters <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/__init__.py#L83"  target="_blank" rel="noopener"
    ><code>create_from_pcd</code></a></p>
<ul>
<li><code>_xyz</code> is set as the basic piont cloud</li>
<li><code>_features_dc</code> and <code>_features_rest</code> are converted from the color of the basic point cloud.
The 0th-order SH coeffs is the rgb. And the rest of coeffs are initialized as 0.</li>
<li><code>spatial_lr_scale</code> is set to the max displacement from the avg cam center.</li>
<li><code>_scaling</code> is initialized with simple_KNN.</li>
<li><code>_rotation</code> is preset with 0 and 1</li>
<li><code>_opacity</code> is initilized as the inverse of sigmoid(0.1)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Training optimization settings, <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/train.py#L36"  target="_blank" rel="noopener"
    ><code>gaussians.training_setup()</code></a></p>
<ul>
<li>lr for each parameter</li>
</ul>
</li>
</ol>
<h3 id="render">Render</h3>
<p>(2024-01-23)</p>
<p><a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/gaussian_renderer/__init__.py#L18"  target="_blank" rel="noopener"
    >render()</a></p>
<ol>
<li><code>screenspace_points</code>: Gaussian centers on the 2D screen are initialized as 0.</li>
</ol>
<hr>
<h2 id="diff_gauss_raster">diff_gauss_raster</h2>
<p>(2023-11-18)</p>
<p><a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization.git"  target="_blank" rel="noopener"
    >Code</a>
| Explaination: <a class="link" href="https://github.com/kwea123/gaussian_splatting_notes"  target="_blank" rel="noopener"
    >kwea123/gaussian_splatting_notes</a></p>
<h3 id="python-invokes">Python Invokes</h3>
<ol>
<li>
<p>The Python program <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/gaussian_renderer/__init__.py#L85"  target="_blank" rel="noopener"
    ><code>gaussian_renderer/__init__.py</code></a>
calls <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/diff_gaussian_rasterization/__init__.py#L187"  target="_blank" rel="noopener"
    ><code>GaussianRasterizer.forward()</code></a>
to render an image tile-by-tile.</p>
</li>
<li>
<p>Internally, program goes to the submodule&rsquo;s <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/diff_gaussian_rasterization/__init__.py#L46"  target="_blank" rel="noopener"
    ><code>_RasterizeGaussians.forward()</code></a>
in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/diff_gaussian_rasterization/__init__.py"  target="_blank" rel="noopener"
    ><code>__ini__.py</code></a>,
analogous to the &ldquo;test.py&rdquo; that calls the cuda-extension package&rsquo;s methods, which are wrapped in PyTorch&rsquo;s forward and backward.</p>
<ul>
<li>
<p><code>_C</code> is a class of the <code>diff_gaussian_rasterization</code> package, as set in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/setup.py#L22"  target="_blank" rel="noopener"
    >setup.py</a></p>
</li>
<li>
<p>The names of package&rsquo;s <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/rasterize_points.h#L19"  target="_blank" rel="noopener"
    >methods</a>
are set in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/ext.cpp#L16"  target="_blank" rel="noopener"
    ><code>PYBIND11_MODULE()</code></a></p>
</li>
</ul>
</li>
</ol>
<h3 id="forward-steps">forward Steps</h3>
<ol>
<li>
<p><code>RasterizeGaussiansCUDA()</code> in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/rasterize_points.cu#L36"  target="_blank" rel="noopener"
    >rasterize_points.cu</a></p>
<ul>
<li>Define <code>geomBuffer</code>, <code>binningBuffer</code>, and <code>imgBuffer</code> for storing data of point cloud, tiles, and the rendered image.
Their memory will be allocated through a Lambda function <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/rasterize_points.cu#L27"  target="_blank" rel="noopener"
    ><code>resizeFunctional()</code></a>,
where tensor&rsquo;s <code>resize_</code> method is called.</li>
</ul>
</li>
<li>
<p>➔ <code>CudaRasterizer::Rasterizer::forward()</code> in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/rasterizer_impl.cu#L198"  target="_blank" rel="noopener"
    >cuda_rasterizer/rasterizer_impl.cu</a></p>
</li>
<li>
<p>➔ <code>FORWARD::preprocess()</code> in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/forward.cu#L402"  target="_blank" rel="noopener"
    >cuda_rasterizer/forward.cu</a></p>
</li>
<li>
<p>➔ <code>preprocessCUDA()</code> in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/forward.cu#L156"  target="_blank" rel="noopener"
    >forward.cu</a></p>
</li>
</ol>
<pre class="pseudocode" data-line-number=true>\begin{algorithm}
\begin{algorithmic}
\STATE RasterizeGaussiansCUDA
\STATE $\quad$ CudaRasterizer::Rasterizer::forward
\STATE $\qquad$ geomState, imgState
\COMMENT{Allocate memory}
\STATE $\qquad$ FORWARD::preprocess
\STATE $\qquad$ cub::DeviceScan::InclusiveSum
\COMMENT{Count tiles}
\STATE $\qquad$ binningState
\STATE $\qquad$ duplicateWithKeys
\STATE $\qquad$ getHigherMsb
\STATE $\qquad$ cub::DeviceRadixSort::SortPairs
\STATE $\qquad$ identifyTileRanges
\STATE $\qquad$ FORWARD::render
\end{algorithmic}
\end{algorithm}
</pre>

<hr>
<h3 id="preprocesscuda">preprocessCUDA</h3>
<ol>
<li>
<p><a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/forward.cu#L193"  target="_blank" rel="noopener"
    >Frustum culling</a></p>
<p>Delete points whose w (equal to depth) is larger than x, y, z in clip space.
However, <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/auxiliary.h#L139"  target="_blank" rel="noopener"
    ><code>in_frustum()</code></a>
is based on coordinates in the camera space.</p>
</li>
<li>
<p>Construct 3D covariance matrix.
<a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/main/cuda_rasterizer/forward.cu#L118"  target="_blank" rel="noopener"
    >Code</a></p>
<p>Given a quaternion $q = [r, \ x, \ y, \ z]$, the rotation matrix is:
<a class="link" href="https://en.wikipedia.org/wiki/Quaternions_and_spatial_rotation#Quaternion-derived_rotation_matrix"  target="_blank" rel="noopener"
    >wiki</a></p>
<p>$$
𝐑 =
\begin{bmatrix}
1 - 2(y² + z²) &amp; 2(xy - rz) &amp; 2(xz + ry) \\
2(xy + rz) &amp; 1 - 2(x² + z²) &amp; 2(yz - rx) \\
2(xz - ry) &amp; 2(yz + rx) &amp; 1 - 2(x²+y²)
\end{bmatrix}
$$</p>
<p>The stretching matrix is diagonal and represented as a 3D vector
$𝐒 = [x, \ y, \ z]$</p>
<p>Covariance matrix (3x3) of 3D Gaussian <code>cov3D</code>: 𝚺 = 𝐑𝐒𝐒ᵀ𝐑ᵀ</p>
</li>
<li>
<p>Covariance matrix (3x3) is projected onto 2D screen <code>cov</code>: 𝚺&rsquo; = 𝐉 𝐖 𝚺 𝐖ᵀ𝐉ᵀ.
<a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/main/cuda_rasterizer/forward.cu#L89-L106"  target="_blank" rel="noopener"
    >Code</a></p>
</li>
<li>
<p>Take the inverse of 𝚺&rsquo; (𝚺&rsquo;⁻¹), <code>conic</code>, to evaluate the 2D Gaussian PDF.
<a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/forward.cu#L219-L223"  target="_blank" rel="noopener"
    >Code</a></p>
</li>
<li>
<p>The extent of a point (Gaussian center) is a bounding square,
where the &ldquo;radius&rdquo; from each side to the projected pixel is <code>my_radius</code>: 3σ.
<a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/forward.cu#L225-L237"  target="_blank" rel="noopener"
    >Code</a></p>
<p>The radius of the circumscribed circle for a 2D Gaussian is the <strong>max</strong> eigenvalue of the 2D covariance matrix $𝐀 = [^{a \ b}_{b \ c}]$.
The eigenvalues can be solved from:</p>
<p>$$
det (𝐀 - λ⋅𝐈) = 0  \\
\begin{vmatrix} a-λ &amp; b \\ b &amp; c-λ\end{vmatrix} = 0  \\
(a-λ)(c-λ) - b^2 = 0  \\
λ^2 - (a+c)λ + ac-b^2 =0
$$</p>
<p>Two roots:
$λ₁,\ λ₂ = \frac{(a+c)}{2} ± \sqrt{\frac{(a+c)²}{4}-(ac-b²)}$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">det</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">cov</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">cov</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">cov</span><span class="p">.</span><span class="n">y</span><span class="p">);</span> <span class="c1">// determinant
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">-</span> <span class="o">-</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">mid</span> <span class="o">=</span> <span class="mf">0.5f</span> <span class="o">*</span> <span class="p">(</span><span class="n">cov</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">cov</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">lambda1</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">0.1f</span><span class="p">,</span> <span class="n">mid</span> <span class="o">*</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">det</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">lambda2</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mf">0.1f</span><span class="p">,</span> <span class="n">mid</span> <span class="o">*</span> <span class="n">mid</span> <span class="o">-</span> <span class="n">det</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Pixel coordinates: Scale the ND coordinates of x,y ∈ [-1,1] to image-grid coordiantes <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/957bb97582554f2198a07ab01166211a1b79dccf/cuda_rasterizer/forward.cu#L233"  target="_blank" rel="noopener"
    ><code>point_image</code></a>
[0,W] through viewport transformation:
$x = \frac{W⋅(x-1)}{2} -0.5,\ y=\frac{H⋅(y-1)}{2} -0.5$</p>
</li>
</ol>
<hr>
<h3 id="prepare-tiles">Prepare Tiles</h3>
<p>(2024-02-02)</p>
<ol>
<li>
<p>Obtain the total sum of touched tiles for all Gaussian centers by <code>inclusive sum</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">cub</span><span class="o">::</span><span class="n">DeviceScan</span><span class="o">::</span><span class="n">InclusiveSum</span><span class="p">(</span><span class="n">geomState</span><span class="p">.</span><span class="n">scanning_space</span><span class="p">,</span> <span class="n">geomState</span><span class="p">.</span><span class="n">scan_size</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">          <span class="n">geomState</span><span class="p">.</span><span class="n">tiles_touched</span><span class="p">,</span> <span class="n">geomState</span><span class="p">.</span><span class="n">point_offsets</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="o">-</span> <span class="o">-</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">num_rendered</span><span class="p">;</span>    <span class="c1">// total number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">CHECK_CUDA</span><span class="p">(</span><span class="n">cudaMemcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_rendered</span><span class="p">,</span> <span class="n">geomState</span><span class="p">.</span><span class="n">point_offsets</span> <span class="o">+</span> <span class="n">P</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">          <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">),</span> <span class="n">debug</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>InclusiveSum</code> produces a <strong>sequence</strong> of prefix sum for <code>tiles_touched</code> (the <strong>number</strong> of touched tiles) of 100k points.</p>
<p>The pointer <code>point_offsets</code> points to the <strong>first</strong> byte of the 100k-byte sequence.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 488 185"
      >
      <g transform='translate(8,16)'>
<path d='M 56,16 L 80,16' fill='none' stroke='currentColor'></path>
<path d='M 80,16 L 104,16' fill='none' stroke='currentColor'></path>
<path d='M 104,16 L 128,16' fill='none' stroke='currentColor'></path>
<path d='M 128,16 L 152,16' fill='none' stroke='currentColor'></path>
<path d='M 152,16 L 176,16' fill='none' stroke='currentColor'></path>
<path d='M 176,16 L 200,16' fill='none' stroke='currentColor'></path>
<path d='M 200,16 L 224,16' fill='none' stroke='currentColor'></path>
<path d='M 280,16 L 304,16' fill='none' stroke='currentColor'></path>
<path d='M 304,16 L 328,16' fill='none' stroke='currentColor'></path>
<path d='M 328,16 L 352,16' fill='none' stroke='currentColor'></path>
<path d='M 56,48 L 80,48' fill='none' stroke='currentColor'></path>
<path d='M 80,48 L 104,48' fill='none' stroke='currentColor'></path>
<path d='M 104,48 L 128,48' fill='none' stroke='currentColor'></path>
<path d='M 128,48 L 152,48' fill='none' stroke='currentColor'></path>
<path d='M 152,48 L 176,48' fill='none' stroke='currentColor'></path>
<path d='M 176,48 L 200,48' fill='none' stroke='currentColor'></path>
<path d='M 200,48 L 224,48' fill='none' stroke='currentColor'></path>
<path d='M 280,48 L 304,48' fill='none' stroke='currentColor'></path>
<path d='M 304,48 L 328,48' fill='none' stroke='currentColor'></path>
<path d='M 328,48 L 352,48' fill='none' stroke='currentColor'></path>
<path d='M 56,80 L 80,80' fill='none' stroke='currentColor'></path>
<path d='M 80,80 L 104,80' fill='none' stroke='currentColor'></path>
<path d='M 104,80 L 128,80' fill='none' stroke='currentColor'></path>
<path d='M 128,80 L 152,80' fill='none' stroke='currentColor'></path>
<path d='M 152,80 L 176,80' fill='none' stroke='currentColor'></path>
<path d='M 176,80 L 200,80' fill='none' stroke='currentColor'></path>
<path d='M 200,80 L 232,80' fill='none' stroke='currentColor'></path>
<path d='M 280,80 L 304,80' fill='none' stroke='currentColor'></path>
<path d='M 304,80 L 328,80' fill='none' stroke='currentColor'></path>
<path d='M 328,80 L 376,80' fill='none' stroke='currentColor'></path>
<path d='M 56,112 L 80,112' fill='none' stroke='currentColor'></path>
<path d='M 80,112 L 104,112' fill='none' stroke='currentColor'></path>
<path d='M 104,112 L 128,112' fill='none' stroke='currentColor'></path>
<path d='M 128,112 L 152,112' fill='none' stroke='currentColor'></path>
<path d='M 152,112 L 176,112' fill='none' stroke='currentColor'></path>
<path d='M 176,112 L 200,112' fill='none' stroke='currentColor'></path>
<path d='M 200,112 L 232,112' fill='none' stroke='currentColor'></path>
<path d='M 280,112 L 304,112' fill='none' stroke='currentColor'></path>
<path d='M 304,112 L 328,112' fill='none' stroke='currentColor'></path>
<path d='M 328,112 L 376,112' fill='none' stroke='currentColor'></path>
<path d='M 56,16 L 56,48' fill='none' stroke='currentColor'></path>
<path d='M 56,80 L 56,112' fill='none' stroke='currentColor'></path>
<path d='M 64,128 L 64,144' fill='none' stroke='currentColor'></path>
<path d='M 80,16 L 80,48' fill='none' stroke='currentColor'></path>
<path d='M 80,80 L 80,112' fill='none' stroke='currentColor'></path>
<path d='M 104,16 L 104,48' fill='none' stroke='currentColor'></path>
<path d='M 104,80 L 104,112' fill='none' stroke='currentColor'></path>
<path d='M 128,16 L 128,48' fill='none' stroke='currentColor'></path>
<path d='M 128,80 L 128,112' fill='none' stroke='currentColor'></path>
<path d='M 152,16 L 152,48' fill='none' stroke='currentColor'></path>
<path d='M 152,80 L 152,112' fill='none' stroke='currentColor'></path>
<path d='M 176,16 L 176,48' fill='none' stroke='currentColor'></path>
<path d='M 176,80 L 176,112' fill='none' stroke='currentColor'></path>
<path d='M 200,16 L 200,48' fill='none' stroke='currentColor'></path>
<path d='M 200,80 L 200,112' fill='none' stroke='currentColor'></path>
<path d='M 224,16 L 224,48' fill='none' stroke='currentColor'></path>
<path d='M 232,80 L 232,112' fill='none' stroke='currentColor'></path>
<path d='M 280,16 L 280,48' fill='none' stroke='currentColor'></path>
<path d='M 280,80 L 280,112' fill='none' stroke='currentColor'></path>
<path d='M 304,16 L 304,48' fill='none' stroke='currentColor'></path>
<path d='M 304,80 L 304,112' fill='none' stroke='currentColor'></path>
<path d='M 328,16 L 328,48' fill='none' stroke='currentColor'></path>
<path d='M 328,80 L 328,112' fill='none' stroke='currentColor'></path>
<path d='M 344,128 L 344,144' fill='none' stroke='currentColor'></path>
<path d='M 352,16 L 352,48' fill='none' stroke='currentColor'></path>
<path d='M 376,80 L 376,112' fill='none' stroke='currentColor'></path>
<path d='M 64,120 L 64,128' fill='none' stroke='currentColor'></path>
<polygon points='80.000000,128.000000 68.000000,122.400002 68.000000,133.600006' fill='currentColor' transform='rotate(270.000000, 64.000000, 128.000000)'></polygon>
<path d='M 344,120 L 344,128' fill='none' stroke='currentColor'></path>
<polygon points='360.000000,128.000000 348.000000,122.400002 348.000000,133.600006' fill='currentColor' transform='rotate(270.000000, 344.000000, 128.000000)'></polygon>
<text text-anchor='middle' x='0' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='0' y='52' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='0' y='100' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='0' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='8' y='36' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='8' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='8' y='100' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='8' y='116' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='16' y='36' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='16' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='16' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='24' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='48' y='164' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='56' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='56' y='164' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='64' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='64' y='36' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='64' y='164' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='72' y='164' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='80' y='164' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='88' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='164' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='96' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='96' y='164' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='104' y='164' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='112' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='112' y='36' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='112' y='100' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='112' y='164' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='120' y='36' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='120' y='100' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='120' y='164' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='128' y='164' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='136' y='4' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='136' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='136' y='100' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='136' y='164' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='144' y='36' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='144' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='144' y='164' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='160' y='36' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='160' y='100' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='168' y='36' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='168' y='100' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='184' y='36' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='184' y='100' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='192' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='208' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='216' y='100' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='224' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='248' y='36' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='248' y='100' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='264' y='36' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='264' y='100' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='288' y='36' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='296' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='312' y='36' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='320' y='36' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='328' y='164' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='336' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='336' y='36' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='336' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='336' y='164' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='344' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='344' y='100' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='344' y='164' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='352' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='100' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='352' y='164' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='360' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='360' y='164' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='368' y='4' fill='currentColor' style='font-size:1em'>K</text>
<text text-anchor='middle' x='368' y='100' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='368' y='164' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='376' y='164' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='384' y='164' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='392' y='164' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='400' y='164' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='408' y='164' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='416' y='164' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='424' y='164' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='432' y='164' fill='currentColor' style='font-size:1em'>+</text>
<text text-anchor='middle' x='440' y='164' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='448' y='164' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='456' y='164' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='464' y='164' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='472' y='164' fill='currentColor' style='font-size:1em'>9</text>
</g>

    </svg>
  
</div>
</li>
<li>
<p><code>P</code> = 100k bytes (char) is the number of points (Gaussian center).</p>
<p>So, <code>point_offsets + P - 1</code> is the last element in the prefix-sum sequence.
Specifically, it&rsquo;s the <strong>total number</strong> of touched tiles for all 100k points.</p>
</li>
</ul>
</li>
</ol>
<hr>
<ol start="2">
<li>
<p>Evaluate <strong>each Gaussian</strong> to pair every touched tile&rsquo;s index and Gaussian&rsquo;s depth:
<a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/957bb97582554f2198a07ab01166211a1b79dccf/cuda_rasterizer/rasterizer_impl.cu#L289"  target="_blank" rel="noopener"
    >Code</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">duplicateWithKeys</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">P</span> <span class="o">+</span> <span class="mi">255</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span> <span class="o">&gt;&gt;</span> <span class="o">&gt;</span> <span class="p">(</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Iterate each tile that a Gaussian overlaps, and combine the tile index and the Gaussian&rsquo;s depth to form a key</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">rect_min</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">rect_max</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">rect_min</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">rect_max</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">gaussian_keys_unsorted</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>100x100 image are divided to tiles with size of 16x16, so the thread gridDim: (7,7,1)</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 448 297"
      >
      <g transform='translate(8,16)'>
<path d='M 16,16 L 48,16' fill='none' stroke='currentColor'></path>
<path d='M 48,16 L 80,16' fill='none' stroke='currentColor'></path>
<path d='M 80,16 L 112,16' fill='none' stroke='currentColor'></path>
<path d='M 112,16 L 144,16' fill='none' stroke='currentColor'></path>
<path d='M 144,16 L 176,16' fill='none' stroke='currentColor'></path>
<path d='M 176,16 L 208,16' fill='none' stroke='currentColor'></path>
<path d='M 208,16 L 240,16' fill='none' stroke='currentColor'></path>
<path d='M 16,48 L 48,48' fill='none' stroke='currentColor'></path>
<path d='M 48,48 L 80,48' fill='none' stroke='currentColor'></path>
<path d='M 80,48 L 112,48' fill='none' stroke='currentColor'></path>
<path d='M 112,48 L 144,48' fill='none' stroke='currentColor'></path>
<path d='M 144,48 L 176,48' fill='none' stroke='currentColor'></path>
<path d='M 176,48 L 208,48' fill='none' stroke='currentColor'></path>
<path d='M 208,48 L 240,48' fill='none' stroke='currentColor'></path>
<path d='M 32,64 L 48,64' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 80,64' fill='none' stroke='currentColor'></path>
<path d='M 80,64 L 96,64' fill='none' stroke='currentColor'></path>
<path d='M 16,80 L 32,80' fill='none' stroke='currentColor'></path>
<path d='M 32,80 L 48,80' fill='none' stroke='currentColor'></path>
<path d='M 48,80 L 80,80' fill='none' stroke='currentColor'></path>
<path d='M 80,80 L 96,80' fill='none' stroke='currentColor'></path>
<path d='M 96,80 L 112,80' fill='none' stroke='currentColor'></path>
<path d='M 112,80 L 144,80' fill='none' stroke='currentColor'></path>
<path d='M 144,80 L 176,80' fill='none' stroke='currentColor'></path>
<path d='M 176,80 L 208,80' fill='none' stroke='currentColor'></path>
<path d='M 208,80 L 240,80' fill='none' stroke='currentColor'></path>
<path d='M 16,112 L 32,112' fill='none' stroke='currentColor'></path>
<path d='M 32,112 L 48,112' fill='none' stroke='currentColor'></path>
<path d='M 48,112 L 80,112' fill='none' stroke='currentColor'></path>
<path d='M 80,112 L 96,112' fill='none' stroke='currentColor'></path>
<path d='M 96,112 L 112,112' fill='none' stroke='currentColor'></path>
<path d='M 112,112 L 144,112' fill='none' stroke='currentColor'></path>
<path d='M 144,112 L 176,112' fill='none' stroke='currentColor'></path>
<path d='M 176,112 L 208,112' fill='none' stroke='currentColor'></path>
<path d='M 208,112 L 240,112' fill='none' stroke='currentColor'></path>
<path d='M 32,128 L 48,128' fill='none' stroke='currentColor'></path>
<path d='M 48,128 L 80,128' fill='none' stroke='currentColor'></path>
<path d='M 80,128 L 96,128' fill='none' stroke='currentColor'></path>
<path d='M 128,128 L 144,128' fill='none' stroke='currentColor'></path>
<path d='M 144,128 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 176,128 L 208,128' fill='none' stroke='currentColor'></path>
<path d='M 208,128 L 240,128' fill='none' stroke='currentColor'></path>
<path d='M 240,128 L 256,128' fill='none' stroke='currentColor'></path>
<path d='M 16,144 L 48,144' fill='none' stroke='currentColor'></path>
<path d='M 48,144 L 80,144' fill='none' stroke='currentColor'></path>
<path d='M 80,144 L 112,144' fill='none' stroke='currentColor'></path>
<path d='M 112,144 L 128,144' fill='none' stroke='currentColor'></path>
<path d='M 128,144 L 144,144' fill='none' stroke='currentColor'></path>
<path d='M 144,144 L 176,144' fill='none' stroke='currentColor'></path>
<path d='M 176,144 L 208,144' fill='none' stroke='currentColor'></path>
<path d='M 208,144 L 240,144' fill='none' stroke='currentColor'></path>
<path d='M 16,176 L 48,176' fill='none' stroke='currentColor'></path>
<path d='M 48,176 L 80,176' fill='none' stroke='currentColor'></path>
<path d='M 80,176 L 112,176' fill='none' stroke='currentColor'></path>
<path d='M 112,176 L 128,176' fill='none' stroke='currentColor'></path>
<path d='M 128,176 L 144,176' fill='none' stroke='currentColor'></path>
<path d='M 144,176 L 176,176' fill='none' stroke='currentColor'></path>
<path d='M 176,176 L 208,176' fill='none' stroke='currentColor'></path>
<path d='M 208,176 L 240,176' fill='none' stroke='currentColor'></path>
<path d='M 272,192 L 288,192' fill='none' stroke='currentColor'></path>
<path d='M 16,208 L 48,208' fill='none' stroke='currentColor'></path>
<path d='M 48,208 L 80,208' fill='none' stroke='currentColor'></path>
<path d='M 80,208 L 112,208' fill='none' stroke='currentColor'></path>
<path d='M 112,208 L 128,208' fill='none' stroke='currentColor'></path>
<path d='M 128,208 L 144,208' fill='none' stroke='currentColor'></path>
<path d='M 144,208 L 176,208' fill='none' stroke='currentColor'></path>
<path d='M 176,208 L 208,208' fill='none' stroke='currentColor'></path>
<path d='M 208,208 L 240,208' fill='none' stroke='currentColor'></path>
<path d='M 16,240 L 48,240' fill='none' stroke='currentColor'></path>
<path d='M 48,240 L 80,240' fill='none' stroke='currentColor'></path>
<path d='M 80,240 L 112,240' fill='none' stroke='currentColor'></path>
<path d='M 112,240 L 128,240' fill='none' stroke='currentColor'></path>
<path d='M 128,240 L 144,240' fill='none' stroke='currentColor'></path>
<path d='M 144,240 L 176,240' fill='none' stroke='currentColor'></path>
<path d='M 176,240 L 208,240' fill='none' stroke='currentColor'></path>
<path d='M 208,240 L 240,240' fill='none' stroke='currentColor'></path>
<path d='M 128,256 L 256,256' fill='none' stroke='currentColor'></path>
<path d='M 272,256 L 288,256' fill='none' stroke='currentColor'></path>
<path d='M 16,16 L 16,48' fill='none' stroke='currentColor'></path>
<path d='M 16,48 L 16,80' fill='none' stroke='currentColor'></path>
<path d='M 16,80 L 16,112' fill='none' stroke='currentColor'></path>
<path d='M 16,112 L 16,144' fill='none' stroke='currentColor'></path>
<path d='M 16,144 L 16,176' fill='none' stroke='currentColor'></path>
<path d='M 16,176 L 16,208' fill='none' stroke='currentColor'></path>
<path d='M 16,208 L 16,240' fill='none' stroke='currentColor'></path>
<path d='M 32,64 L 32,80' fill='none' stroke='currentColor'></path>
<path d='M 32,80 L 32,112' fill='none' stroke='currentColor'></path>
<path d='M 32,112 L 32,128' fill='none' stroke='currentColor'></path>
<path d='M 48,16 L 48,48' fill='none' stroke='currentColor'></path>
<path d='M 48,48 L 48,64' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 48,80' fill='none' stroke='currentColor'></path>
<path d='M 48,80 L 48,112' fill='none' stroke='currentColor'></path>
<path d='M 48,112 L 48,128' fill='none' stroke='currentColor'></path>
<path d='M 48,128 L 48,144' fill='none' stroke='currentColor'></path>
<path d='M 48,144 L 48,176' fill='none' stroke='currentColor'></path>
<path d='M 48,176 L 48,208' fill='none' stroke='currentColor'></path>
<path d='M 48,208 L 48,240' fill='none' stroke='currentColor'></path>
<path d='M 80,16 L 80,48' fill='none' stroke='currentColor'></path>
<path d='M 80,48 L 80,64' fill='none' stroke='currentColor'></path>
<path d='M 80,64 L 80,80' fill='none' stroke='currentColor'></path>
<path d='M 80,80 L 80,112' fill='none' stroke='currentColor'></path>
<path d='M 80,112 L 80,128' fill='none' stroke='currentColor'></path>
<path d='M 80,128 L 80,144' fill='none' stroke='currentColor'></path>
<path d='M 80,144 L 80,176' fill='none' stroke='currentColor'></path>
<path d='M 80,176 L 80,208' fill='none' stroke='currentColor'></path>
<path d='M 80,208 L 80,240' fill='none' stroke='currentColor'></path>
<path d='M 96,64 L 96,80' fill='none' stroke='currentColor'></path>
<path d='M 96,80 L 96,112' fill='none' stroke='currentColor'></path>
<path d='M 96,112 L 96,128' fill='none' stroke='currentColor'></path>
<path d='M 112,16 L 112,48' fill='none' stroke='currentColor'></path>
<path d='M 112,48 L 112,80' fill='none' stroke='currentColor'></path>
<path d='M 112,80 L 112,112' fill='none' stroke='currentColor'></path>
<path d='M 112,112 L 112,144' fill='none' stroke='currentColor'></path>
<path d='M 112,144 L 112,176' fill='none' stroke='currentColor'></path>
<path d='M 112,176 L 112,208' fill='none' stroke='currentColor'></path>
<path d='M 112,208 L 112,240' fill='none' stroke='currentColor'></path>
<path d='M 128,128 L 128,144' fill='none' stroke='currentColor'></path>
<path d='M 128,144 L 128,176' fill='none' stroke='currentColor'></path>
<path d='M 128,176 L 128,208' fill='none' stroke='currentColor'></path>
<path d='M 128,208 L 128,240' fill='none' stroke='currentColor'></path>
<path d='M 128,240 L 128,256' fill='none' stroke='currentColor'></path>
<path d='M 144,16 L 144,48' fill='none' stroke='currentColor'></path>
<path d='M 144,48 L 144,80' fill='none' stroke='currentColor'></path>
<path d='M 144,80 L 144,112' fill='none' stroke='currentColor'></path>
<path d='M 144,112 L 144,128' fill='none' stroke='currentColor'></path>
<path d='M 144,128 L 144,144' fill='none' stroke='currentColor'></path>
<path d='M 144,144 L 144,176' fill='none' stroke='currentColor'></path>
<path d='M 144,176 L 144,208' fill='none' stroke='currentColor'></path>
<path d='M 144,208 L 144,240' fill='none' stroke='currentColor'></path>
<path d='M 176,16 L 176,48' fill='none' stroke='currentColor'></path>
<path d='M 176,48 L 176,80' fill='none' stroke='currentColor'></path>
<path d='M 176,80 L 176,112' fill='none' stroke='currentColor'></path>
<path d='M 176,112 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 176,128 L 176,144' fill='none' stroke='currentColor'></path>
<path d='M 176,144 L 176,176' fill='none' stroke='currentColor'></path>
<path d='M 176,176 L 176,208' fill='none' stroke='currentColor'></path>
<path d='M 176,208 L 176,240' fill='none' stroke='currentColor'></path>
<path d='M 208,16 L 208,48' fill='none' stroke='currentColor'></path>
<path d='M 208,48 L 208,80' fill='none' stroke='currentColor'></path>
<path d='M 208,80 L 208,112' fill='none' stroke='currentColor'></path>
<path d='M 208,112 L 208,128' fill='none' stroke='currentColor'></path>
<path d='M 208,128 L 208,144' fill='none' stroke='currentColor'></path>
<path d='M 208,144 L 208,176' fill='none' stroke='currentColor'></path>
<path d='M 208,176 L 208,208' fill='none' stroke='currentColor'></path>
<path d='M 208,208 L 208,240' fill='none' stroke='currentColor'></path>
<path d='M 240,16 L 240,48' fill='none' stroke='currentColor'></path>
<path d='M 240,48 L 240,80' fill='none' stroke='currentColor'></path>
<path d='M 240,80 L 240,112' fill='none' stroke='currentColor'></path>
<path d='M 240,112 L 240,128' fill='none' stroke='currentColor'></path>
<path d='M 240,128 L 240,144' fill='none' stroke='currentColor'></path>
<path d='M 240,144 L 240,176' fill='none' stroke='currentColor'></path>
<path d='M 240,176 L 240,208' fill='none' stroke='currentColor'></path>
<path d='M 240,208 L 240,240' fill='none' stroke='currentColor'></path>
<path d='M 256,128 L 256,256' fill='none' stroke='currentColor'></path>
<path d='M 280,200 L 280,208' fill='none' stroke='currentColor'></path>
<polygon points='296.000000,208.000000 284.000000,202.399994 284.000000,213.600006' fill='currentColor' transform='rotate(270.000000, 280.000000, 208.000000)'></polygon>
<path d='M 280,240 L 280,248' fill='none' stroke='currentColor'></path>
<polygon points='296.000000,240.000000 284.000000,234.399994 284.000000,245.600006' fill='currentColor' transform='rotate(90.000000, 280.000000, 240.000000)'></polygon>
<circle cx='64' cy='96' r='6' stroke='currentColor' fill='currentColor'></circle>
<circle cx='192' cy='192' r='6' stroke='currentColor' fill='currentColor'></circle>
<text text-anchor='middle' x='0' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='0' y='68' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='0' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='0' y='132' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='0' y='164' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='0' y='196' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='0' y='228' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='32' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>▦</text>
<text text-anchor='middle' x='64' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='96' y='276' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='104' y='276' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='276' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='120' y='276' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='128' y='4' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='128' y='276' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='136' y='276' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='144' y='276' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='152' y='276' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='264' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='272' y='116' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='280' y='116' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='280' y='228' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='288' y='116' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='288' y='228' fill='currentColor' style='font-size:1em'>σ</text>
<text text-anchor='middle' x='296' y='116' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='304' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='312' y='116' fill='currentColor' style='font-size:1em'>x</text>
</g>

    </svg>
  
</div>
<p>For example, the above small Gaussian covers 9 tiles at: (0,1), (1,1), (2,1), (0,2), (1,2), (2,2), (0,3), (1,3), (2,3)</p>
<p>The tile index is computed as <code>y*grid.x + x</code>. Therefore, the 9 tiles&rsquo; indices are: 8,9,10, 15,16,17, 22,23,24</p>
</li>
<li>
<p>Suppose the tile id is 24 and the Gaussian&rsquo;s depth is 15.7 (cast to int 15), the corresponding pair&rsquo;s <code>key</code> is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">tile id 24:          0000_0000_0000_0000_0000_0000_0001_1000
</span></span><span class="line"><span class="cl">Shift left <span class="m">32</span> bits:  0000_0000_0000_0000_0000_0000_0001_1000_0000_0000_0000_0000_0000_0000_0000_0000
</span></span><span class="line"><span class="cl">combine depth <span class="o">(</span>15<span class="o">)</span>:  0000_0000_0000_0000_0000_0000_0001_1000_0000_0000_0000_0000_0000_0000_0000_1111
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Because each Gaussian is processed by a thread <strong>in parallel</strong>, the prefix sum <code>point_offsets</code> is referenced
to locate the starting cell for each Gaussian to store <code>key</code>s into corresponding area of the array <code>gaussian_keys_unsorted</code>:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 496 217"
      >
      <g transform='translate(8,16)'>
<path d='M 48,64 L 72,64' fill='none' stroke='currentColor'></path>
<path d='M 72,64 L 96,64' fill='none' stroke='currentColor'></path>
<path d='M 96,64 L 120,64' fill='none' stroke='currentColor'></path>
<path d='M 120,64 L 144,64' fill='none' stroke='currentColor'></path>
<path d='M 144,64 L 168,64' fill='none' stroke='currentColor'></path>
<path d='M 168,64 L 192,64' fill='none' stroke='currentColor'></path>
<path d='M 192,64 L 216,64' fill='none' stroke='currentColor'></path>
<path d='M 216,64 L 240,64' fill='none' stroke='currentColor'></path>
<path d='M 240,64 L 264,64' fill='none' stroke='currentColor'></path>
<path d='M 264,64 L 288,64' fill='none' stroke='currentColor'></path>
<path d='M 288,64 L 312,64' fill='none' stroke='currentColor'></path>
<path d='M 312,64 L 336,64' fill='none' stroke='currentColor'></path>
<path d='M 368,64 L 392,64' fill='none' stroke='currentColor'></path>
<path d='M 392,64 L 416,64' fill='none' stroke='currentColor'></path>
<path d='M 416,64 L 440,64' fill='none' stroke='currentColor'></path>
<path d='M 440,64 L 464,64' fill='none' stroke='currentColor'></path>
<path d='M 48,96 L 72,96' fill='none' stroke='currentColor'></path>
<path d='M 72,96 L 96,96' fill='none' stroke='currentColor'></path>
<path d='M 96,96 L 120,96' fill='none' stroke='currentColor'></path>
<path d='M 120,96 L 144,96' fill='none' stroke='currentColor'></path>
<path d='M 144,96 L 168,96' fill='none' stroke='currentColor'></path>
<path d='M 168,96 L 192,96' fill='none' stroke='currentColor'></path>
<path d='M 192,96 L 216,96' fill='none' stroke='currentColor'></path>
<path d='M 216,96 L 240,96' fill='none' stroke='currentColor'></path>
<path d='M 240,96 L 264,96' fill='none' stroke='currentColor'></path>
<path d='M 264,96 L 288,96' fill='none' stroke='currentColor'></path>
<path d='M 288,96 L 312,96' fill='none' stroke='currentColor'></path>
<path d='M 312,96 L 336,96' fill='none' stroke='currentColor'></path>
<path d='M 368,96 L 392,96' fill='none' stroke='currentColor'></path>
<path d='M 392,96 L 416,96' fill='none' stroke='currentColor'></path>
<path d='M 416,96 L 440,96' fill='none' stroke='currentColor'></path>
<path d='M 440,96 L 464,96' fill='none' stroke='currentColor'></path>
<path d='M 64,160 L 232,160' fill='none' stroke='currentColor'></path>
<path d='M 384,160 L 448,160' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 48,96' fill='none' stroke='currentColor'></path>
<path d='M 64,112 L 64,128' fill='none' stroke='currentColor'></path>
<path d='M 72,64 L 72,96' fill='none' stroke='currentColor'></path>
<path d='M 96,64 L 96,96' fill='none' stroke='currentColor'></path>
<path d='M 120,64 L 120,96' fill='none' stroke='currentColor'></path>
<path d='M 144,64 L 144,96' fill='none' stroke='currentColor'></path>
<path d='M 168,64 L 168,96' fill='none' stroke='currentColor'></path>
<path d='M 192,64 L 192,96' fill='none' stroke='currentColor'></path>
<path d='M 216,64 L 216,96' fill='none' stroke='currentColor'></path>
<path d='M 240,64 L 240,96' fill='none' stroke='currentColor'></path>
<path d='M 264,64 L 264,96' fill='none' stroke='currentColor'></path>
<path d='M 272,112 L 272,160' fill='none' stroke='currentColor'></path>
<path d='M 288,64 L 288,96' fill='none' stroke='currentColor'></path>
<path d='M 304,112 L 304,128' fill='none' stroke='currentColor'></path>
<path d='M 312,64 L 312,96' fill='none' stroke='currentColor'></path>
<path d='M 336,64 L 336,96' fill='none' stroke='currentColor'></path>
<path d='M 368,64 L 368,96' fill='none' stroke='currentColor'></path>
<path d='M 376,112 L 376,128' fill='none' stroke='currentColor'></path>
<path d='M 392,64 L 392,96' fill='none' stroke='currentColor'></path>
<path d='M 416,64 L 416,96' fill='none' stroke='currentColor'></path>
<path d='M 440,64 L 440,96' fill='none' stroke='currentColor'></path>
<path d='M 464,64 L 464,96' fill='none' stroke='currentColor'></path>
<path d='M 64,104 L 64,112' fill='none' stroke='currentColor'></path>
<polygon points='80.000000,112.000000 68.000000,106.400002 68.000000,117.599998' fill='currentColor' transform='rotate(270.000000, 64.000000, 112.000000)'></polygon>
<path d='M 272,104 L 272,112' fill='none' stroke='currentColor'></path>
<polygon points='288.000000,112.000000 276.000000,106.400002 276.000000,117.599998' fill='currentColor' transform='rotate(270.000000, 272.000000, 112.000000)'></polygon>
<path d='M 304,104 L 304,112' fill='none' stroke='currentColor'></path>
<polygon points='320.000000,112.000000 308.000000,106.400002 308.000000,117.599998' fill='currentColor' transform='rotate(270.000000, 304.000000, 112.000000)'></polygon>
<path d='M 376,104 L 376,112' fill='none' stroke='currentColor'></path>
<polygon points='392.000000,112.000000 380.000000,106.400002 380.000000,117.599998' fill='currentColor' transform='rotate(270.000000, 376.000000, 112.000000)'></polygon>
<path d='M 48,144 A 16,16 0 0,0 64,160' fill='none' stroke='currentColor'></path>
<path d='M 248,144 A 16,16 0 0,1 232,160' fill='none' stroke='currentColor'></path>
<path d='M 296,144 A 16,16 0 0,0 312,160' fill='none' stroke='currentColor'></path>
<path d='M 368,144 A 16,16 0 0,0 384,160' fill='none' stroke='currentColor'></path>
<path d='M 464,144 A 16,16 0 0,1 448,160' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='4' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='0' y='116' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='8' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='8' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='8' y='84' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='8' y='116' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='16' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='16' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='16' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='16' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='24' y='4' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='24' y='20' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='24' y='52' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='24' y='84' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='32' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='32' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='32' y='84' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='40' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='40' y='20' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='84' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='56' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='56' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='52' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='104' y='52' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='112' y='180' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='120' y='180' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='128' y='52' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='128' y='180' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='136' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='144' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='152' y='52' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='176' y='52' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='200' y='52' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='224' y='52' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='248' y='52' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='256' y='180' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='264' y='180' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='272' y='52' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='272' y='180' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='272' y='196' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='280' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='288' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='296' y='52' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='180' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='312' y='180' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='312' y='196' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='320' y='164' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='320' y='180' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='328' y='164' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='328' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='336' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='352' y='20' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='352' y='52' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='352' y='84' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='352' y='196' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='392' y='180' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='392' y='196' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='400' y='180' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='400' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='408' y='180' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='408' y='196' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='416' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='416' y='196' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='424' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='448' y='20' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='448' y='52' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='456' y='20' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='456' y='52' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='464' y='20' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='464' y='52' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='472' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='472' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='480' y='20' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='480' y='52' fill='currentColor' style='font-size:1em'>6</text>
</g>

    </svg>
  
</div>
</li>
<li>
<p>The <code>value</code> is the Gaussian&rsquo;s index ranging in [0, 100k-1], i.e., the thread index <code>idx</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">cg</span><span class="o">::</span><span class="n">this_grid</span><span class="p">().</span><span class="n">thread_rank</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">---</span>
</span></span><span class="line"><span class="cl"><span class="n">gaussian_values_unsorted</span><span class="p">[</span><span class="n">off</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<hr>
<ol start="3">
<li>
<p>With performing <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/957bb97582554f2198a07ab01166211a1b79dccf/cuda_rasterizer/rasterizer_impl.cu#L303"  target="_blank" rel="noopener"
    ><code>SortPairs</code></a>,
the tile-Gaussian pairs sequence (<code>binningState.point_list_keys</code>) is arranged based on the tile ID,
and for keys with identical tile id, the depths are then sorted.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CHECK_CUDA</span><span class="p">(</span><span class="n">cub</span><span class="o">::</span><span class="n">DeviceRadixSort</span><span class="o">::</span><span class="n">SortPairs</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">binningState</span><span class="p">.</span><span class="n">point_list_keys_unsorted</span><span class="p">,</span> <span class="n">binningState</span><span class="p">.</span><span class="n">point_list_keys</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">binningState</span><span class="p">.</span><span class="n">point_list_unsorted</span><span class="p">,</span> <span class="n">binningState</span><span class="p">.</span><span class="n">point_list</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div>


<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 496 169"
      >
      <g transform='translate(8,16)'>
<path d='M 64,32 L 96,32' fill='none' stroke='currentColor'></path>
<path d='M 96,32 L 128,32' fill='none' stroke='currentColor'></path>
<path d='M 160,32 L 216,32' fill='none' stroke='currentColor'></path>
<path d='M 216,32 L 272,32' fill='none' stroke='currentColor'></path>
<path d='M 304,32 L 312,32' fill='none' stroke='currentColor'></path>
<path d='M 368,32 L 376,32' fill='none' stroke='currentColor'></path>
<path d='M 376,32 L 424,32' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 72,64' fill='none' stroke='currentColor'></path>
<path d='M 72,64 L 96,64' fill='none' stroke='currentColor'></path>
<path d='M 96,64 L 120,64' fill='none' stroke='currentColor'></path>
<path d='M 120,64 L 144,64' fill='none' stroke='currentColor'></path>
<path d='M 144,64 L 168,64' fill='none' stroke='currentColor'></path>
<path d='M 168,64 L 192,64' fill='none' stroke='currentColor'></path>
<path d='M 192,64 L 216,64' fill='none' stroke='currentColor'></path>
<path d='M 216,64 L 240,64' fill='none' stroke='currentColor'></path>
<path d='M 240,64 L 264,64' fill='none' stroke='currentColor'></path>
<path d='M 264,64 L 288,64' fill='none' stroke='currentColor'></path>
<path d='M 288,64 L 312,64' fill='none' stroke='currentColor'></path>
<path d='M 312,64 L 336,64' fill='none' stroke='currentColor'></path>
<path d='M 368,64 L 392,64' fill='none' stroke='currentColor'></path>
<path d='M 392,64 L 416,64' fill='none' stroke='currentColor'></path>
<path d='M 416,64 L 440,64' fill='none' stroke='currentColor'></path>
<path d='M 48,96 L 72,96' fill='none' stroke='currentColor'></path>
<path d='M 72,96 L 96,96' fill='none' stroke='currentColor'></path>
<path d='M 96,96 L 120,96' fill='none' stroke='currentColor'></path>
<path d='M 120,96 L 144,96' fill='none' stroke='currentColor'></path>
<path d='M 144,96 L 168,96' fill='none' stroke='currentColor'></path>
<path d='M 168,96 L 192,96' fill='none' stroke='currentColor'></path>
<path d='M 192,96 L 216,96' fill='none' stroke='currentColor'></path>
<path d='M 216,96 L 240,96' fill='none' stroke='currentColor'></path>
<path d='M 240,96 L 264,96' fill='none' stroke='currentColor'></path>
<path d='M 264,96 L 288,96' fill='none' stroke='currentColor'></path>
<path d='M 288,96 L 312,96' fill='none' stroke='currentColor'></path>
<path d='M 312,96 L 336,96' fill='none' stroke='currentColor'></path>
<path d='M 368,96 L 392,96' fill='none' stroke='currentColor'></path>
<path d='M 392,96 L 416,96' fill='none' stroke='currentColor'></path>
<path d='M 416,96 L 440,96' fill='none' stroke='currentColor'></path>
<path d='M 48,48 L 48,64' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 48,96' fill='none' stroke='currentColor'></path>
<path d='M 72,64 L 72,96' fill='none' stroke='currentColor'></path>
<path d='M 96,16 L 96,32' fill='none' stroke='currentColor'></path>
<path d='M 96,64 L 96,96' fill='none' stroke='currentColor'></path>
<path d='M 120,64 L 120,96' fill='none' stroke='currentColor'></path>
<path d='M 144,48 L 144,64' fill='none' stroke='currentColor'></path>
<path d='M 144,64 L 144,96' fill='none' stroke='currentColor'></path>
<path d='M 168,64 L 168,96' fill='none' stroke='currentColor'></path>
<path d='M 192,64 L 192,96' fill='none' stroke='currentColor'></path>
<path d='M 216,16 L 216,32' fill='none' stroke='currentColor'></path>
<path d='M 216,64 L 216,96' fill='none' stroke='currentColor'></path>
<path d='M 240,64 L 240,96' fill='none' stroke='currentColor'></path>
<path d='M 264,64 L 264,96' fill='none' stroke='currentColor'></path>
<path d='M 288,48 L 288,64' fill='none' stroke='currentColor'></path>
<path d='M 288,64 L 288,96' fill='none' stroke='currentColor'></path>
<path d='M 312,64 L 312,96' fill='none' stroke='currentColor'></path>
<path d='M 336,64 L 336,96' fill='none' stroke='currentColor'></path>
<path d='M 368,64 L 368,96' fill='none' stroke='currentColor'></path>
<path d='M 376,16 L 376,32' fill='none' stroke='currentColor'></path>
<path d='M 392,64 L 392,96' fill='none' stroke='currentColor'></path>
<path d='M 416,64 L 416,96' fill='none' stroke='currentColor'></path>
<path d='M 440,48 L 440,64' fill='none' stroke='currentColor'></path>
<path d='M 440,64 L 440,96' fill='none' stroke='currentColor'></path>
<path d='M 64,32 A 16,16 0 0,0 48,48' fill='none' stroke='currentColor'></path>
<path d='M 128,32 A 16,16 0 0,1 144,48' fill='none' stroke='currentColor'></path>
<path d='M 160,32 A 16,16 0 0,0 144,48' fill='none' stroke='currentColor'></path>
<path d='M 272,32 A 16,16 0 0,1 288,48' fill='none' stroke='currentColor'></path>
<path d='M 304,32 A 16,16 0 0,0 288,48' fill='none' stroke='currentColor'></path>
<path d='M 424,32 A 16,16 0 0,1 440,48' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='116' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='8' y='84' fill='currentColor' style='font-size:1em'>K</text>
<text text-anchor='middle' x='8' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='16' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='16' y='132' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='24' y='84' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='24' y='132' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='32' y='84' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='132' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='84' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='48' y='132' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='56' y='132' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='56' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='72' y='116' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='72' y='132' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='80' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='96' y='116' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='96' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='104' y='116' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='104' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='104' y='148' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='112' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='120' y='116' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='120' y='132' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='128' y='116' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='128' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='128' y='148' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='144' y='116' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='144' y='132' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='152' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='152' y='132' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='152' y='148' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='168' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='168' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='176' y='132' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='176' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='192' y='116' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='192' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='200' y='116' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='200' y='132' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='200' y='148' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='216' y='132' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='224' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='224' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='232' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='240' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='248' y='132' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='248' y='148' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='264' y='116' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='264' y='132' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='272' y='116' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='272' y='132' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='272' y='148' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='288' y='116' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='288' y='132' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='296' y='116' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='296' y='132' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='296' y='148' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='312' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='312' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='320' y='36' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='320' y='116' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='320' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='148' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='328' y='36' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='352' y='84' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='368' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='368' y='116' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='368' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='376' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='376' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='376' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='376' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='384' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='392' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='392' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='392' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='400' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='400' y='132' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='400' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='408' y='4' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='416' y='4' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='416' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='416' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='424' y='132' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='424' y='148' fill='currentColor' style='font-size:1em'>5</text>
</g>

    </svg>
  
</div>
</li>
</ol>
<hr>
<ol start="4">
<li>
<p>Evaluate <strong>each pair</strong> to identify the <strong>boundaries</strong> <code>ranges</code> of each tile for rendering.
<a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/957bb97582554f2198a07ab01166211a1b79dccf/cuda_rasterizer/rasterizer_impl.cu#L313"  target="_blank" rel="noopener"
    >Code</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">identifyTileRanges</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">num_rendered</span> <span class="o">+</span> <span class="mi">255</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span> <span class="o">&gt;&gt;</span> <span class="o">&gt;</span> <span class="p">(</span>
</span></span></code></pre></td></tr></table>
</div>
</div>


<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 504 201"
      >
      <g transform='translate(8,16)'>
<path d='M 72,32 L 104,32' fill='none' stroke='currentColor'></path>
<path d='M 104,32 L 136,32' fill='none' stroke='currentColor'></path>
<path d='M 168,32 L 224,32' fill='none' stroke='currentColor'></path>
<path d='M 224,32 L 280,32' fill='none' stroke='currentColor'></path>
<path d='M 312,32 L 320,32' fill='none' stroke='currentColor'></path>
<path d='M 376,32 L 384,32' fill='none' stroke='currentColor'></path>
<path d='M 384,32 L 416,32' fill='none' stroke='currentColor'></path>
<path d='M 48,112 L 72,112' fill='none' stroke='currentColor'></path>
<path d='M 72,112 L 96,112' fill='none' stroke='currentColor'></path>
<path d='M 96,112 L 120,112' fill='none' stroke='currentColor'></path>
<path d='M 120,112 L 144,112' fill='none' stroke='currentColor'></path>
<path d='M 144,112 L 168,112' fill='none' stroke='currentColor'></path>
<path d='M 168,112 L 192,112' fill='none' stroke='currentColor'></path>
<path d='M 192,112 L 216,112' fill='none' stroke='currentColor'></path>
<path d='M 216,112 L 240,112' fill='none' stroke='currentColor'></path>
<path d='M 240,112 L 264,112' fill='none' stroke='currentColor'></path>
<path d='M 264,112 L 288,112' fill='none' stroke='currentColor'></path>
<path d='M 288,112 L 312,112' fill='none' stroke='currentColor'></path>
<path d='M 312,112 L 336,112' fill='none' stroke='currentColor'></path>
<path d='M 368,112 L 392,112' fill='none' stroke='currentColor'></path>
<path d='M 392,112 L 416,112' fill='none' stroke='currentColor'></path>
<path d='M 416,112 L 440,112' fill='none' stroke='currentColor'></path>
<path d='M 48,144 L 72,144' fill='none' stroke='currentColor'></path>
<path d='M 72,144 L 96,144' fill='none' stroke='currentColor'></path>
<path d='M 96,144 L 120,144' fill='none' stroke='currentColor'></path>
<path d='M 120,144 L 144,144' fill='none' stroke='currentColor'></path>
<path d='M 144,144 L 168,144' fill='none' stroke='currentColor'></path>
<path d='M 168,144 L 192,144' fill='none' stroke='currentColor'></path>
<path d='M 192,144 L 216,144' fill='none' stroke='currentColor'></path>
<path d='M 216,144 L 240,144' fill='none' stroke='currentColor'></path>
<path d='M 240,144 L 264,144' fill='none' stroke='currentColor'></path>
<path d='M 264,144 L 288,144' fill='none' stroke='currentColor'></path>
<path d='M 288,144 L 312,144' fill='none' stroke='currentColor'></path>
<path d='M 312,144 L 336,144' fill='none' stroke='currentColor'></path>
<path d='M 368,144 L 392,144' fill='none' stroke='currentColor'></path>
<path d='M 392,144 L 416,144' fill='none' stroke='currentColor'></path>
<path d='M 416,144 L 440,144' fill='none' stroke='currentColor'></path>
<path d='M 48,112 L 48,144' fill='none' stroke='currentColor'></path>
<path d='M 64,160 L 64,176' fill='none' stroke='currentColor'></path>
<path d='M 72,112 L 72,144' fill='none' stroke='currentColor'></path>
<path d='M 88,160 L 88,176' fill='none' stroke='currentColor'></path>
<path d='M 96,112 L 96,144' fill='none' stroke='currentColor'></path>
<path d='M 104,16 L 104,32' fill='none' stroke='currentColor'></path>
<path d='M 112,160 L 112,176' fill='none' stroke='currentColor'></path>
<path d='M 120,112 L 120,144' fill='none' stroke='currentColor'></path>
<path d='M 136,160 L 136,176' fill='none' stroke='currentColor'></path>
<path d='M 144,112 L 144,144' fill='none' stroke='currentColor'></path>
<path d='M 152,88 L 152,104' fill='none' stroke='currentColor'></path>
<path d='M 160,160 L 160,176' fill='none' stroke='currentColor'></path>
<path d='M 168,112 L 168,144' fill='none' stroke='currentColor'></path>
<path d='M 184,160 L 184,176' fill='none' stroke='currentColor'></path>
<path d='M 192,112 L 192,144' fill='none' stroke='currentColor'></path>
<path d='M 208,160 L 208,176' fill='none' stroke='currentColor'></path>
<path d='M 216,112 L 216,144' fill='none' stroke='currentColor'></path>
<path d='M 224,16 L 224,32' fill='none' stroke='currentColor'></path>
<path d='M 232,160 L 232,176' fill='none' stroke='currentColor'></path>
<path d='M 240,112 L 240,144' fill='none' stroke='currentColor'></path>
<path d='M 256,160 L 256,176' fill='none' stroke='currentColor'></path>
<path d='M 264,112 L 264,144' fill='none' stroke='currentColor'></path>
<path d='M 280,160 L 280,176' fill='none' stroke='currentColor'></path>
<path d='M 288,112 L 288,144' fill='none' stroke='currentColor'></path>
<path d='M 296,88 L 296,104' fill='none' stroke='currentColor'></path>
<path d='M 304,160 L 304,176' fill='none' stroke='currentColor'></path>
<path d='M 312,112 L 312,144' fill='none' stroke='currentColor'></path>
<path d='M 328,160 L 328,176' fill='none' stroke='currentColor'></path>
<path d='M 336,112 L 336,144' fill='none' stroke='currentColor'></path>
<path d='M 368,112 L 368,144' fill='none' stroke='currentColor'></path>
<path d='M 384,16 L 384,32' fill='none' stroke='currentColor'></path>
<path d='M 384,160 L 384,176' fill='none' stroke='currentColor'></path>
<path d='M 392,112 L 392,144' fill='none' stroke='currentColor'></path>
<path d='M 408,160 L 408,176' fill='none' stroke='currentColor'></path>
<path d='M 416,112 L 416,144' fill='none' stroke='currentColor'></path>
<path d='M 432,88 L 432,104' fill='none' stroke='currentColor'></path>
<path d='M 432,160 L 432,176' fill='none' stroke='currentColor'></path>
<path d='M 440,112 L 440,144' fill='none' stroke='currentColor'></path>
<path d='M 152,96 L 152,104' fill='none' stroke='currentColor'></path>
<path d='M 296,96 L 296,104' fill='none' stroke='currentColor'></path>
<path d='M 432,96 L 432,104' fill='none' stroke='currentColor'></path>
<path d='M 64,152 L 64,160' fill='none' stroke='currentColor'></path>
<polygon points='80.000000,160.000000 68.000000,154.399994 68.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 64.000000, 160.000000)'></polygon>
<path d='M 88,152 L 88,160' fill='none' stroke='currentColor'></path>
<polygon points='104.000000,160.000000 92.000000,154.399994 92.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 88.000000, 160.000000)'></polygon>
<path d='M 112,152 L 112,160' fill='none' stroke='currentColor'></path>
<polygon points='128.000000,160.000000 116.000000,154.399994 116.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 112.000000, 160.000000)'></polygon>
<path d='M 136,152 L 136,160' fill='none' stroke='currentColor'></path>
<polygon points='152.000000,160.000000 140.000000,154.399994 140.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 136.000000, 160.000000)'></polygon>
<path d='M 160,152 L 160,160' fill='none' stroke='currentColor'></path>
<polygon points='176.000000,160.000000 164.000000,154.399994 164.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 160.000000, 160.000000)'></polygon>
<path d='M 184,152 L 184,160' fill='none' stroke='currentColor'></path>
<polygon points='200.000000,160.000000 188.000000,154.399994 188.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 184.000000, 160.000000)'></polygon>
<path d='M 208,152 L 208,160' fill='none' stroke='currentColor'></path>
<polygon points='224.000000,160.000000 212.000000,154.399994 212.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 208.000000, 160.000000)'></polygon>
<path d='M 232,152 L 232,160' fill='none' stroke='currentColor'></path>
<polygon points='248.000000,160.000000 236.000000,154.399994 236.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 232.000000, 160.000000)'></polygon>
<path d='M 256,152 L 256,160' fill='none' stroke='currentColor'></path>
<polygon points='272.000000,160.000000 260.000000,154.399994 260.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 256.000000, 160.000000)'></polygon>
<path d='M 280,152 L 280,160' fill='none' stroke='currentColor'></path>
<polygon points='296.000000,160.000000 284.000000,154.399994 284.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 280.000000, 160.000000)'></polygon>
<path d='M 304,152 L 304,160' fill='none' stroke='currentColor'></path>
<polygon points='320.000000,160.000000 308.000000,154.399994 308.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 304.000000, 160.000000)'></polygon>
<path d='M 328,152 L 328,160' fill='none' stroke='currentColor'></path>
<polygon points='344.000000,160.000000 332.000000,154.399994 332.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 328.000000, 160.000000)'></polygon>
<path d='M 384,152 L 384,160' fill='none' stroke='currentColor'></path>
<polygon points='400.000000,160.000000 388.000000,154.399994 388.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 384.000000, 160.000000)'></polygon>
<path d='M 408,152 L 408,160' fill='none' stroke='currentColor'></path>
<polygon points='424.000000,160.000000 412.000000,154.399994 412.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 408.000000, 160.000000)'></polygon>
<path d='M 432,152 L 432,160' fill='none' stroke='currentColor'></path>
<polygon points='448.000000,160.000000 436.000000,154.399994 436.000000,165.600006' fill='currentColor' transform='rotate(270.000000, 432.000000, 160.000000)'></polygon>
<path d='M 72,32 A 16,16 0 0,0 56,48' fill='none' stroke='currentColor'></path>
<path d='M 136,32 A 16,16 0 0,1 152,48' fill='none' stroke='currentColor'></path>
<path d='M 168,32 A 16,16 0 0,0 152,48' fill='none' stroke='currentColor'></path>
<path d='M 280,32 A 16,16 0 0,1 296,48' fill='none' stroke='currentColor'></path>
<path d='M 312,32 A 16,16 0 0,0 296,48' fill='none' stroke='currentColor'></path>
<path d='M 416,32 A 16,16 0 0,1 432,48' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='100' fill='currentColor' style='font-size:1em'>B</text>
<text text-anchor='middle' x='0' y='164' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='0' y='180' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='8' y='100' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='8' y='132' fill='currentColor' style='font-size:1em'>K</text>
<text text-anchor='middle' x='8' y='164' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='8' y='180' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='16' y='100' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='16' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='16' y='164' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='16' y='180' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='24' y='84' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='24' y='132' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='24' y='164' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='24' y='180' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='32' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='32' y='132' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='164' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='32' y='180' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='40' y='84' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='40' y='132' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='164' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='40' y='180' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='84' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='48' y='164' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='48' y='180' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='56' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>|</text>
<text text-anchor='middle' x='64' y='84' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='72' y='84' fill='currentColor' style='font-size:1em'>[</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='80' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='88' y='84' fill='currentColor' style='font-size:1em'>]</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='96' y='84' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='104' y='84' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='68' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='128' y='84' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='136' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='136' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='144' y='68' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='144' y='84' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='152' y='68' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='152' y='84' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='160' y='68' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='160' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='168' y='68' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='168' y='84' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='176' y='68' fill='currentColor' style='font-size:1em'>[</text>
<text text-anchor='middle' x='176' y='84' fill='currentColor' style='font-size:1em'>[</text>
<text text-anchor='middle' x='184' y='68' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='184' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='68' fill='currentColor' style='font-size:1em'>]</text>
<text text-anchor='middle' x='192' y='84' fill='currentColor' style='font-size:1em'>]</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='200' y='68' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='200' y='84' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='208' y='68' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='208' y='84' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='272' y='68' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='272' y='84' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='280' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='280' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='288' y='68' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='288' y='84' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='296' y='68' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='296' y='84' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='304' y='68' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='304' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='312' y='68' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='312' y='84' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='320' y='68' fill='currentColor' style='font-size:1em'>[</text>
<text text-anchor='middle' x='320' y='84' fill='currentColor' style='font-size:1em'>[</text>
<text text-anchor='middle' x='328' y='36' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='328' y='68' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='328' y='84' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='336' y='36' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='336' y='68' fill='currentColor' style='font-size:1em'>]</text>
<text text-anchor='middle' x='336' y='84' fill='currentColor' style='font-size:1em'>]</text>
<text text-anchor='middle' x='344' y='68' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='344' y='84' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='352' y='68' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='352' y='84' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='352' y='132' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='376' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='384' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='392' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='400' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='400' y='84' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='408' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='416' y='4' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='416' y='84' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='424' y='4' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='424' y='84' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='432' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='440' y='84' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='448' y='84' fill='currentColor' style='font-size:1em'>[</text>
<text text-anchor='middle' x='456' y='84' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='464' y='84' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='472' y='84' fill='currentColor' style='font-size:1em'>]</text>
<text text-anchor='middle' x='480' y='84' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='488' y='84' fill='currentColor' style='font-size:1em'>y</text>
</g>

    </svg>
  
</div>
</li>
</ol>
<hr>
<h3 id="render-pixel">Render Pixel</h3>
<p>(2024-02-05)</p>
<p><strong>A block for a tile; A thread for a Gaussian; A pixel is an iterative composition of multiple Gaussian.</strong>
Ultimately, in the end, a thread in a block corresponds to a pixel.</p>
<p>A thread syntheses a single <strong>pixel</strong> by performing alpha compositing Gaussian-by-Gaussian.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">renderCUDA</span><span class="o">&lt;</span><span class="n">NUM_CHANNELS</span><span class="o">&gt;</span> <span class="o">&lt;&lt;</span> <span class="o">&lt;</span><span class="n">grid</span><span class="p">,</span> <span class="n">block</span> <span class="o">&gt;&gt;</span> <span class="o">&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="c1">// grid: (7,7,1), block: (16,16,1), 49*256 threads for 100x100 pix
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>A pixel&rsquo;s color is rendered within the tile encompassing it, based on the obtained sorted sequence of Gaussians&rsquo; indices.</p>
</li>
<li>
<p>All pixels in a tile correspond to the same Gaussians, but with different weights,
as the weights depend on distance from the pixel coordinates to the 2D Gaussian center.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 432 169"
      >
      <g transform='translate(8,16)'>
<path d='M 48,48 L 88,48' fill='none' stroke='currentColor'></path>
<path d='M 32,96 L 88,96' fill='none' stroke='currentColor'></path>
<path d='M 16,64 L 16,128' fill='none' stroke='currentColor'></path>
<path d='M 48,0 L 48,48' fill='none' stroke='currentColor'></path>
<path d='M 48,48 L 48,64' fill='none' stroke='currentColor'></path>
<path d='M 16,64 L 48,0' fill='none' stroke='currentColor'></path>
<path d='M 16,128 L 32,96' fill='none' stroke='currentColor'></path>
<path d='M 32,96 L 48,64' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='8' y='100' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='8' y='148' fill='currentColor' style='font-size:1em'>A</text>
<text text-anchor='middle' x='16' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='24' y='36' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>■</text>
<text text-anchor='middle' x='24' y='148' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='32' y='148' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>■</text>
<text text-anchor='middle' x='40' y='148' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='48' y='148' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='88' y='20' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='96' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='104' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='104' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='104' y='52' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='104' y='100' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='112' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='152' y='36' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='152' y='52' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='152' y='100' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='160' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='168' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='184' y='20' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='192' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='200' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='200' y='36' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='200' y='52' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='200' y='100' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='208' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='216' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='240' y='52' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='240' y='100' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='280' y='20' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='288' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='296' y='36' fill='currentColor' style='font-size:1em'>j</text>
<text text-anchor='middle' x='296' y='52' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='296' y='100' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='312' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='344' y='52' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='344' y='100' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='384' y='20' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='384' y='36' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='392' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='392' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='400' y='20' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='400' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='400' y='52' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='400' y='100' fill='currentColor' style='font-size:1em'>▨</text>
<text text-anchor='middle' x='408' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='408' y='36' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='416' y='20' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='416' y='36' fill='currentColor' style='font-size:1em'>e</text>
</g>

    </svg>
  
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">toDo</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="p">...</span>
</span></span><span class="line"><span class="cl">     <span class="n">float2</span> <span class="n">xy</span> <span class="o">=</span> <span class="n">collected_xy</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="c1">// pixel coords
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">float2</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="n">xy</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">pixf</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">xy</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">pixf</span><span class="p">.</span><span class="n">y</span> <span class="p">};</span> <span class="c1">// dist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="n">float4</span> <span class="n">con_o</span> <span class="o">=</span> <span class="n">collected_conic_opacity</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="c1">// cov
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="kt">float</span> <span class="n">power</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5f</span> <span class="o">*</span> <span class="p">(</span><span class="n">con_o</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">con_o</span><span class="p">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">con_o</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The coordinates of the pixel to be rendered by a thread is obtained as followes:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 528 233"
      >
      <g transform='translate(8,16)'>
<path d='M 64,64 L 88,64' fill='none' stroke='currentColor'></path>
<path d='M 88,64 L 192,64' fill='none' stroke='currentColor'></path>
<path d='M 104,96 L 152,96' fill='none' stroke='currentColor'></path>
<path d='M 152,128 L 192,128' fill='none' stroke='currentColor'></path>
<path d='M 192,128 L 216,128' fill='none' stroke='currentColor'></path>
<path d='M 104,144 L 152,144' fill='none' stroke='currentColor'></path>
<path d='M 64,176 L 192,176' fill='none' stroke='currentColor'></path>
<path d='M 64,64 L 64,176' fill='none' stroke='currentColor'></path>
<path d='M 88,32 L 88,64' fill='none' stroke='currentColor'></path>
<path d='M 88,64 L 88,80' fill='none' stroke='currentColor'></path>
<path d='M 104,96 L 104,144' fill='none' stroke='currentColor'></path>
<path d='M 152,96 L 152,128' fill='none' stroke='currentColor'></path>
<path d='M 152,128 L 152,144' fill='none' stroke='currentColor'></path>
<path d='M 192,64 L 192,128' fill='none' stroke='currentColor'></path>
<path d='M 192,128 L 192,176' fill='none' stroke='currentColor'></path>
<polygon points='96.000000,32.000000 84.000000,26.400000 84.000000,37.599998' fill='currentColor' transform='rotate(270.000000, 88.000000, 32.000000)'></polygon>
<text text-anchor='middle' x='0' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='0' y='132' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='8' y='116' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='8' y='132' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='16' y='132' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='24' y='52' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='24' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='32' y='132' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='40' y='132' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='52' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='56' y='4' fill='currentColor' style='font-size:1em'>A</text>
<text text-anchor='middle' x='56' y='20' fill='currentColor' style='font-size:1em'>A</text>
<text text-anchor='middle' x='56' y='52' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='64' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='72' y='20' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='72' y='52' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='72' y='212' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='80' y='20' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='80' y='212' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='88' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>□</text>
<text text-anchor='middle' x='88' y='212' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='96' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='96' y='212' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='104' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='112' y='4' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='112' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='112' y='52' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='112' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='112' y='132' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='112' y='212' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='120' y='52' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='120' y='116' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='120' y='212' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='128' y='4' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='128' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='128' y='132' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='128' y='212' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='136' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='136' y='52' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='136' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='136' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='136' y='212' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='144' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='144' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='144' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='144' y='132' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='144' y='212' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='152' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='152' y='52' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='152' y='212' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='160' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='160' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='160' y='212' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='168' y='4' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='168' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='168' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='176' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='176' y='20' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='176' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='176' y='196' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='176' y='212' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='184' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='20' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='184' y='196' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='184' y='212' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='192' y='20' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='192' y='196' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='192' y='212' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='200' y='20' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='200' y='196' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='200' y='212' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>+</text>
<text text-anchor='middle' x='208' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='208' y='196' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='208' y='212' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='216' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='216' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='224' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='224' y='196' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='232' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='232' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='232' y='116' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='232' y='132' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='232' y='148' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='240' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='20' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='240' y='132' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='240' y='148' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='248' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='248' y='20' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='248' y='132' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='248' y='148' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='256' y='4' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='256' y='20' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='256' y='132' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='256' y='148' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='264' y='4' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='264' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='264' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='264' y='132' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='264' y='148' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='272' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='272' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='272' y='132' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='272' y='148' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='280' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='280' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='280' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='280' y='132' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='280' y='148' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='288' y='4' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='288' y='20' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='288' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='288' y='132' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='288' y='148' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='296' y='4' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='304' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='304' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='304' y='132' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='304' y='148' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='312' y='4' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='312' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='312' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='312' y='132' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='312' y='148' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='320' y='20' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='320' y='116' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='320' y='148' fill='currentColor' style='font-size:1em'>v</text>
<text text-anchor='middle' x='328' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='328' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='336' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='336' y='20' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='336' y='116' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='336' y='148' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='344' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='344' y='20' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='344' y='148' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='352' y='4' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='352' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='352' y='148' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='360' y='4' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='360' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='368' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='368' y='20' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='368' y='148' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='376' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='376' y='20' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='376' y='148' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='384' y='4' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='384' y='20' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='384' y='148' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='392' y='4' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='392' y='20' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='400' y='4' fill='currentColor' style='font-size:1em'>+</text>
<text text-anchor='middle' x='400' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='400' y='148' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='408' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='408' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='408' y='148' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='416' y='4' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='416' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='416' y='148' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='424' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='424' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='424' y='148' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='432' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='432' y='20' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='432' y='148' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='440' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='440' y='20' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='440' y='148' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='448' y='4' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='448' y='20' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='448' y='148' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='456' y='4' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='456' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='464' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='464' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='472' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='472' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='480' y='4' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='480' y='20' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='488' y='4' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='488' y='20' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='496' y='4' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='496' y='20' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='504' y='4' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='504' y='20' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='512' y='20' fill='currentColor' style='font-size:1em'>)</text>
</g>

    </svg>
  
</div>
<ul>
<li><code>pix_min</code> = (2 * BLOCK_X, 1 * BLOCK_Y) = (32, 16)</li>
<li><code>pix_max</code> = (max(32+BLOCK_X, W), max(16+BLOCK_Y, H)) = (48, 32)</li>
<li><code>pix</code> = (48+block.thread_index().x, 32+block.thread_index().y)</li>
<li><code>pix_id</code> = 100*pix.y + pix.x</li>
<li>tile id = 1*7 + 2 = 9</li>
<li><code>range = ranges[9]</code>, number of Gaussians for this tile.</li>
</ul>
</li>
<li>
<p>After the pixel is fully rendered as the accumulated transmittance <code>T</code> is close to 0.0,
this thread is assigned to transfer data (Gaussian properties) from the global memory to shared memory.</p>
</li>
</ul>
<hr>
<p>(2023-02-06)  <a id="repeat-work"></a></p>
<p><strong>A 16×16 thread block works repeatedly for one tile.</strong></p>
<p>In NeRF, a rendering batch comprises multiple <strong>rays</strong> emitted from pixels,
while in 3DGS, a rendering batch is a tile (16x16) of <strong>pixels</strong>.</p>
<ul>
<li>
<p>Different tile has different number of tile-Gaussian pairs (<code>range</code>).
Thus, each tile requires varying computations.</p>
</li>
<li>
<p>Each pixel in a <strong>tile</strong> results from multiple (<code>range</code>) tile-Gaussian pairs.
Each tile-Gaussian pair is a &ldquo;filter composition&rdquo; and requires a thread to execute <strong>once</strong>.
As only a single 16x16 thread block is assigned to render the tile.
To fulfill all the tile-Gaussian pairs composition, the equal amount (<code>range</code>) of thread executions are needed.
Thus, the computation for a tile has to re-use the 16x16 thread block several times  repeatedly, i.e., <code>rounds</code> <strong>times</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">uint2</span> <span class="n">range</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="n">block</span><span class="p">.</span><span class="n">group_index</span><span class="p">().</span><span class="n">y</span> <span class="o">*</span> <span class="n">horizontal_blocks</span> <span class="o">+</span> <span class="n">block</span><span class="p">.</span><span class="n">group_index</span><span class="p">().</span><span class="n">x</span><span class="p">];</span>  <span class="c1">// given tile index, read (starting pair, ending tile-Gaussian pair)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">int</span> <span class="n">rounds</span> <span class="o">=</span> <span class="p">((</span><span class="n">range</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">range</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">BLOCK_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">BLOCK_SIZE</span><span class="p">);</span>	<span class="c1">// the number of 16x16 blocks are allocated based on the number of tile-Gaussian pairs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">toDo</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">range</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>	<span class="c1">// number of tile-Gaussian pairs to render the tile
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>For example, if the tile 0 corresponds to 158 tile-Gaussian pairs in the sorted list: <code>point_list_keys</code>,
the 16x16 thread block runs only once to render pixels in tile 0.
And if tile 1&rsquo;s <code>range</code> is 768 tile-Gaussian pairs, 3-round executions are needed.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 520 185"
      >
      <g transform='translate(8,16)'>
<path d='M 24,16 L 104,16' fill='none' stroke='currentColor'></path>
<path d='M 120,16 L 200,16' fill='none' stroke='currentColor'></path>
<path d='M 216,16 L 296,16' fill='none' stroke='currentColor'></path>
<path d='M 312,16 L 392,16' fill='none' stroke='currentColor'></path>
<path d='M 424,16 L 456,16' fill='none' stroke='currentColor'></path>
<path d='M 456,16 L 504,16' fill='none' stroke='currentColor'></path>
<path d='M 24,96 L 104,96' fill='none' stroke='currentColor'></path>
<path d='M 120,96 L 200,96' fill='none' stroke='currentColor'></path>
<path d='M 216,96 L 296,96' fill='none' stroke='currentColor'></path>
<path d='M 312,96 L 392,96' fill='none' stroke='currentColor'></path>
<path d='M 424,96 L 456,96' fill='none' stroke='currentColor'></path>
<path d='M 456,96 L 504,96' fill='none' stroke='currentColor'></path>
<path d='M 24,16 L 24,96' fill='none' stroke='currentColor'></path>
<path d='M 104,16 L 104,96' fill='none' stroke='currentColor'></path>
<path d='M 120,16 L 120,96' fill='none' stroke='currentColor'></path>
<path d='M 200,16 L 200,96' fill='none' stroke='currentColor'></path>
<path d='M 216,16 L 216,96' fill='none' stroke='currentColor'></path>
<path d='M 296,16 L 296,96' fill='none' stroke='currentColor'></path>
<path d='M 312,16 L 312,96' fill='none' stroke='currentColor'></path>
<path d='M 392,16 L 392,96' fill='none' stroke='currentColor'></path>
<path d='M 424,16 L 424,96' fill='none' stroke='currentColor'></path>
<path d='M 456,16 L 456,96' fill='none' stroke='currentColor'></path>
<path d='M 504,16 L 504,96' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='0' y='132' fill='currentColor' style='font-size:1em'>⋮</text>
<text text-anchor='middle' x='0' y='148' fill='currentColor' style='font-size:1em'>⋮</text>
<text text-anchor='middle' x='0' y='164' fill='currentColor' style='font-size:1em'>H</text>
<text text-anchor='middle' x='8' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='8' y='100' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='24' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>C</text>
<text text-anchor='middle' x='40' y='132' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='40' y='148' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='48' y='132' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='56' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='56' y='132' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='56' y='148' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='64' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='64' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='64' y='148' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='72' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='72' y='116' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='72' y='148' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='80' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='80' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='148' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='88' y='36' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='88' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='88' y='148' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='128' y='4' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='128' y='36' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='136' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='136' y='116' fill='currentColor' style='font-size:1em'>C</text>
<text text-anchor='middle' x='136' y='132' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='136' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='144' y='36' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='144' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='144' y='132' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='152' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='152' y='116' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='152' y='132' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='152' y='148' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='160' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='160' y='116' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='160' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='160' y='148' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='168' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='168' y='116' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='168' y='148' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='176' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='176' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='176' y='148' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='36' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='184' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='184' y='148' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='192' y='148' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='224' y='36' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='232' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='232' y='116' fill='currentColor' style='font-size:1em'>C</text>
<text text-anchor='middle' x='232' y='132' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='240' y='36' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='240' y='132' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='248' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='248' y='132' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='256' y='36' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='256' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='264' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='264' y='116' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='272' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='272' y='116' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='272' y='132' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='280' y='36' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='280' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='288' y='4' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='296' y='4' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='312' y='4' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='320' y='4' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='320' y='36' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='328' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='336' y='36' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='344' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='352' y='36' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='360' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='368' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='36' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='384' y='4' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='392' y='4' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='408' y='4' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='408' y='68' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='424' y='4' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='432' y='4' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='432' y='36' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='440' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='448' y='36' fill='currentColor' style='font-size:1em'>k</text>
<text text-anchor='middle' x='456' y='4' fill='currentColor' style='font-size:1em'>W</text>
<text text-anchor='middle' x='464' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='472' y='36' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='480' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='488' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='488' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='496' y='4' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='496' y='36' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='504' y='4' fill='currentColor' style='font-size:1em'>2</text>
</g>

    </svg>
  
</div>
</li>
<li>
<p>Every Gaussian gets added onto <strong>every pixel</strong> (color += color * alpha * T) until a pixel gets fully rendered,
i.e., T is close to 0:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Iterate tiles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rounds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">toDo</span> <span class="o">-=</span> <span class="n">BLOCK_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if pixels in the tile are all rendered, break
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Iterate Gaussians
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">BLOCK_SIZE</span><span class="p">,</span> <span class="n">toDo</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add a Gaussian to every pixel with specific weight
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">CHANNELS</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">C</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">+=</span> <span class="n">features</span><span class="p">[</span><span class="n">collected_id</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">CHANNELS</span> <span class="o">+</span> <span class="n">ch</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>The alpha compositing can be calculated <strong>in parallel</strong>,
as the cumulative summation is definite and independent of the adding sequence.</p>
</li>
</ul>
<hr>
<h2 id="backward">Backward</h2>
<p>Looking up definitions: &ldquo;backward.cu&rdquo; ← &ldquo;rasterizer_impl.cu&rdquo; ← &ldquo;rasterize_points.cu&rdquo; ← &ldquo;__init__.py&rdquo;</p>
<h3 id="back-render">back render</h3>
<p>(2024-02-09)  <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/rasterizer_impl.cu#L390"  target="_blank" rel="noopener"
    >Calling entry</a></p>
<p>The rendered pixel is derived from color (R,G,B) and opacity of each Gaussian.</p>
<p>Derivative flows backward:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 512 105"
      >
      <g transform='translate(8,16)'>
<path d='M 280,16 L 304,16' fill='none' stroke='currentColor'></path>
<path d='M 56,32 L 80,32' fill='none' stroke='currentColor'></path>
<path d='M 144,32 L 160,32' fill='none' stroke='currentColor'></path>
<path d='M 320,48 L 360,48' fill='none' stroke='currentColor'></path>
<path d='M 432,48 L 456,48' fill='none' stroke='currentColor'></path>
<path d='M 176,64 L 208,64' fill='none' stroke='currentColor'></path>
<path d='M 280,64 L 304,64' fill='none' stroke='currentColor'></path>
<path d='M 144,80 L 160,80' fill='none' stroke='currentColor'></path>
<path d='M 176,48 L 176,64' fill='none' stroke='currentColor'></path>
<path d='M 320,32 L 320,48' fill='none' stroke='currentColor'></path>
<polygon points='64.000000,32.000000 52.000000,26.400000 52.000000,37.599998' fill='currentColor' transform='rotate(180.000000, 56.000000, 32.000000)'></polygon>
<polygon points='152.000000,32.000000 140.000000,26.400000 140.000000,37.599998' fill='currentColor' transform='rotate(180.000000, 144.000000, 32.000000)'></polygon>
<polygon points='152.000000,80.000000 140.000000,74.400002 140.000000,85.599998' fill='currentColor' transform='rotate(180.000000, 144.000000, 80.000000)'></polygon>
<polygon points='288.000000,16.000000 276.000000,10.400000 276.000000,21.600000' fill='currentColor' transform='rotate(180.000000, 280.000000, 16.000000)'></polygon>
<polygon points='288.000000,64.000000 276.000000,58.400002 276.000000,69.599998' fill='currentColor' transform='rotate(180.000000, 280.000000, 64.000000)'></polygon>
<polygon points='440.000000,48.000000 428.000000,42.400002 428.000000,53.599998' fill='currentColor' transform='rotate(180.000000, 432.000000, 48.000000)'></polygon>
<path d='M 304,16 A 16,16 0 0,1 320,32' fill='none' stroke='currentColor'></path>
<path d='M 160,32 A 16,16 0 0,1 176,48' fill='none' stroke='currentColor'></path>
<path d='M 320,48 A 16,16 0 0,1 304,64' fill='none' stroke='currentColor'></path>
<path d='M 176,64 A 16,16 0 0,1 160,80' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='36' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='8' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='16' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='24' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='80' y='84' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='88' y='52' fill='currentColor' style='font-size:1em'>w</text>
<text text-anchor='middle' x='88' y='84' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='96' y='36' fill='currentColor' style='font-size:1em'>𝚺</text>
<text text-anchor='middle' x='96' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='96' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='104' y='36' fill='currentColor' style='font-size:1em'>'</text>
<text text-anchor='middle' x='104' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='104' y='84' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='112' y='36' fill='currentColor' style='font-size:1em'>⁻</text>
<text text-anchor='middle' x='112' y='52' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='112' y='84' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='120' y='36' fill='currentColor' style='font-size:1em'>¹</text>
<text text-anchor='middle' x='120' y='52' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='120' y='84' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='128' y='52' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='128' y='84' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='184' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='192' y='52' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='216' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='216' y='52' fill='currentColor' style='font-size:1em'>G</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='224' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='224' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='224' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='232' y='4' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='232' y='20' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='232' y='52' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='232' y='68' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='240' y='4' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='240' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='240' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='240' y='68' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='248' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='248' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='248' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='248' y='68' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='256' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='256' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='256' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='264' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='264' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='272' y='4' fill='currentColor' style='font-size:1em'>ₖ</text>
<text text-anchor='middle' x='272' y='52' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='280' y='52' fill='currentColor' style='font-size:1em'>ₖ</text>
<text text-anchor='middle' x='328' y='36' fill='currentColor' style='font-size:1em'>∑</text>
<text text-anchor='middle' x='336' y='36' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='344' y='36' fill='currentColor' style='font-size:1em'>α</text>
<text text-anchor='middle' x='352' y='36' fill='currentColor' style='font-size:1em'>T</text>
<text text-anchor='middle' x='376' y='36' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='376' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='384' y='36' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='384' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='392' y='36' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='392' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='400' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='400' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='408' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='408' y='52' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='472' y='52' fill='currentColor' style='font-size:1em'>L</text>
<text text-anchor='middle' x='480' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='488' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='496' y='52' fill='currentColor' style='font-size:1em'>s</text>
</g>

    </svg>
  
</div>
<p>The partial derivatives of Loss w.r.t. each Gaussian can be computed <strong>in parallel</strong> similar to forward rendering,
as the contribution is a summation?</p>
<ul>
<li>Incoming upstream gradient: <code>dL_dpixels</code></li>
<li>Accumulated transmittance over all Gaussians is known, so accumulated transmittance of <strong>each</strong> Gaussian can be accquired with:
$T_{curr} = \frac{T_{curr+1}}{(1-α_{curr})} $</li>
</ul>
<p>(2024-02-10)</p>
<p>For color scalar (R,G,B) in each channel k:</p>
<ol>
<li>
<p>Partial derivative of Loss w.r.t. each Gaussian&rsquo;s color: <code>d</code></p>
<p>$$\rm \frac{∂C_{pixel}}{∂C_{k}} = α_{curr}⋅ T_{curr}$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">T</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.f</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">dchannel_dcolor</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">T</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">float</span> <span class="n">dL_dchannel</span> <span class="o">=</span> <span class="n">dL_dpixel</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// add to previous dL_dcolors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dL_dcolors</span><span class="p">[</span><span class="n">global_id</span> <span class="o">*</span> <span class="n">C</span> <span class="o">+</span> <span class="n">ch</span><span class="p">]),</span> <span class="n">dchannel_dcolor</span> <span class="o">*</span> <span class="n">dL_dchannel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Partial derivative of Loss w.r.t. each Gaussian&rsquo;s alpha: <code>d</code></p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 296 89"
      >
      <g transform='translate(8,16)'>
<path d='M 32,0 L 56,0' fill='none' stroke='currentColor'></path>
<path d='M 232,16 L 256,16' fill='none' stroke='currentColor'></path>
<path d='M 232,48 L 256,48' fill='none' stroke='currentColor'></path>
<path d='M 232,16 L 232,48' fill='none' stroke='currentColor'></path>
<path d='M 256,16 L 256,48' fill='none' stroke='currentColor'></path>
<polygon points='40.000000,0.000000 28.000000,-5.600000 28.000000,5.600000' fill='currentColor' transform='rotate(180.000000, 32.000000, 0.000000)'></polygon>
<path d='M 16,16 A 16,16 0 0,0 0,32' fill='none' stroke='currentColor'></path>
<path d='M 16,16 A 16,16 0 0,1 32,32' fill='none' stroke='currentColor'></path>
<path d='M 80,16 A 16,16 0 0,0 64,32' fill='none' stroke='currentColor'></path>
<path d='M 80,16 A 16,16 0 0,1 96,32' fill='none' stroke='currentColor'></path>
<path d='M 144,16 A 16,16 0 0,0 128,32' fill='none' stroke='currentColor'></path>
<path d='M 144,16 A 16,16 0 0,1 160,32' fill='none' stroke='currentColor'></path>
<path d='M 0,32 A 16,16 0 0,0 16,48' fill='none' stroke='currentColor'></path>
<path d='M 32,32 A 16,16 0 0,1 16,48' fill='none' stroke='currentColor'></path>
<path d='M 64,32 A 16,16 0 0,0 80,48' fill='none' stroke='currentColor'></path>
<path d='M 96,32 A 16,16 0 0,1 80,48' fill='none' stroke='currentColor'></path>
<path d='M 128,32 A 16,16 0 0,0 144,48' fill='none' stroke='currentColor'></path>
<path d='M 160,32 A 16,16 0 0,1 144,48' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='68' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='8' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='16' y='68' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='24' y='68' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='32' y='68' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='40' y='68' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>✚</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='72' y='68' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='80' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='88' y='68' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>w</text>
<text text-anchor='middle' x='96' y='68' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='112' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='112' y='36' fill='currentColor' style='font-size:1em'>✚</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='136' y='4' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='136' y='68' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='144' y='4' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='144' y='68' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='152' y='4' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='152' y='68' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='160' y='68' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='168' y='4' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='176' y='4' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='176' y='36' fill='currentColor' style='font-size:1em'>✚</text>
<text text-anchor='middle' x='184' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='192' y='36' fill='currentColor' style='font-size:1em'>⋯</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>=</text>
<text text-anchor='middle' x='232' y='68' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='240' y='68' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='248' y='68' fill='currentColor' style='font-size:1em'>x</text>
</g>

    </svg>
  
</div>
<p>$$
\begin{aligned}
\rm C_{pix} &amp;= \rm  C_{last-1} α_{last-1} T_{curr}(1-α_{curr})(1-α_{last}) +
C_{last}α_{last}T_{curr}(1-α_{curr}) + C_{curr} α_{curr} T_{curr} + ⋯
\\
\rm \frac{∂C_{pix}}{∂α_{curr}} &amp;= \rm  - C_{last-1} α_{last-1} T_{curr}(1-α_{last}) -
C_{last}α_{last}T_{curr} + C_{curr} T_{curr}
\\
&amp;= \rm (C_{curr} - \underbrace{C_{last-1} α_{last-1}}_{\text{accum rec}} (1-α_{last}) - C_{last}α_{last}) ⋅ T_{curr} \\
\rm \frac{∂L}{∂α_{curr}} &amp;= \rm \frac{∂L}{∂C_{pix}}⋅ \frac{∂C_{pix}}{∂α_{curr}}
\end{aligned}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>  <span class="c1">// R,G,B 3 chnls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">float</span> <span class="n">c</span> <span class="o">=</span> <span class="n">collected_colors</span><span class="p">[</span><span class="n">ch</span> <span class="o">*</span> <span class="n">BLOCK_SIZE</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">accum_rec</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_alpha</span> <span class="o">*</span> <span class="n">last_color</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.f</span> <span class="o">-</span> <span class="n">last_alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">accum_rec</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">last_color</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">float</span> <span class="n">dL_dchannel</span> <span class="o">=</span> <span class="n">dL_dpixel</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">dL_dalpha</span> <span class="o">+=</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">accum_rec</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span> <span class="o">*</span> <span class="n">dL_dchannel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dalpha</span> <span class="o">*=</span> <span class="n">T</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><details><summary>Old notes</summary>
<p>$$
\rm \frac{∂C_{pixel}}{∂ α_{curr}} = C_{k} T_{curr} - \frac{∑_{m&gt;curr}cₘ⋅αₘ⋅ Tₘ}{1-α_{curr}}
$$</p>
<p>A summation of subsequent Gaussians which are based on the current Gaussian.</p>
<p>As the solving process starts from the rare Gaussian that depends on all previous Gaussians to,
when calculating the current Gaussian, the summation of Gaussians affected by it is ready to use.</p>
</details>
<p>Consider the contribution of background color to the pixel color finally:</p>
<p>$$
\begin{aligned}
\rm C_{pix} &amp;= \rm C_{gs} + T_{final}C_{bg} \\
\rm \frac{∂ L}{∂ α_{gs}} &amp;= \rm \frac{∂ L}{∂ C_{pix}} ⋅ ( \frac{∂C_{pix}}{∂α_{gs}} +
\frac{∂C_{pix}}{∂T_{final}} ⋅ \frac{∂T_{final}}{∂α_{gs}} ) \\
&amp;= \rm \frac{∂L}{∂α_{gs}} + \frac{∂ L}{∂ C_{pix}} ⋅ C_{bg} ⋅ (-\frac{T_{final}}{(1-α_{gs})})
\end{aligned}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">bg_dot_dpixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bg_dot_dpixel</span> <span class="o">+=</span> <span class="n">bg_color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dpixel</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dalpha</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="n">T_final</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.f</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">bg_dot_dpixel</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Partial derivative of Loss w.r.t. 2D means:</p>
<p>$$ \begin{aligned}
G &amp;= e^{-½ (\bm μ-𝐱)ᵀ \bm Σ⁻¹ (\bm μ-𝐱)} \\
&amp;= exp(-½ ⋅ [μₓ-x \ μ_y-y] ⋅ [^{a \ b}_{d \ c}] ⋅ [^{μₓ-x} _{μ_y-y}])\\
&amp;= exp(-½⋅ (a⋅Δₓ² + (b+d)⋅ΔₓΔ_y + c⋅Δ_y²)) \\
α &amp;= o ⋅ G \\
\frac{∂α}{∂Δₓ} &amp;= o⋅G⋅ (-aΔₓ - bΔ_y) \\
\frac{∂L}{∂μ_{x(flim)}} &amp;= \frac{∂L}{∂α}⋅ \frac{∂α}{∂Δₓ}⋅ \frac{∂Δₓ}{∂μₓ} ⋅ \frac{∂μₓ}{∂μ_{x (film)}}
\\
&amp;= \frac{∂L}{∂α} ⋅o⋅G⋅ (-aΔₓ - bΔ_y) ⋅ 1 ⋅ \frac{W}{2}
\end{aligned} $$</p>
<ul>
<li>Although b=d, to be consistent with the derivative ∂L/∂b in the Jacobian matrix,
the b and d keep separated instead of using b+d = 2b.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">ddelx_dx</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">W</span><span class="p">;</span> <span class="c1">// viewport transform
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">float</span> <span class="n">ddely_dy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">H</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">dL_dG</span> <span class="o">=</span> <span class="n">con_o</span><span class="p">.</span><span class="n">w</span> <span class="o">*</span> <span class="n">dL_dalpha</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">gdx</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">gdy</span> <span class="o">=</span> <span class="n">G</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">dG_ddelx</span> <span class="o">=</span> <span class="o">-</span><span class="n">gdx</span> <span class="o">*</span> <span class="n">con_o</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">gdy</span> <span class="o">*</span> <span class="n">con_o</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">float</span> <span class="n">dG_ddely</span> <span class="o">=</span> <span class="o">-</span><span class="n">gdy</span> <span class="o">*</span> <span class="n">con_o</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">gdx</span> <span class="o">*</span> <span class="n">con_o</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Update gradients w.r.t. 2D mean position of the Gaussian
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">global_id</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="n">dL_dG</span> <span class="o">*</span> <span class="n">dG_ddelx</span> <span class="o">*</span> <span class="n">ddelx_dx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">global_id</span><span class="p">].</span><span class="n">y</span><span class="p">,</span> <span class="n">dL_dG</span> <span class="o">*</span> <span class="n">dG_ddely</span> <span class="o">*</span> <span class="n">ddely_dy</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Partial derivative of Loss w.r.t. 3 elements a,b,c in the <strong>inverse</strong> of 2D covariance matrix,
based on $α = o⋅G = o⋅exp(-\frac{1}{2}Δₓᵀ[^{a\ b}_{d\ c}]Δₓ)$:</p>
<ul>
<li>Note: Here $[^{a\ b}_{d\ c}]$ represents the inverse cov 𝚺⁻¹, not the original cov2D 𝚺.</li>
</ul>
<p>$$ \frac{∂L}{∂a} = \frac{∂L}{∂α}⋅ \frac{∂α}{∂a}
= \frac{∂L}{∂α}⋅ o ⋅ G ⋅ (-½Δₓ²) $$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dL_dconic2D</span><span class="p">[</span><span class="n">global_id</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5f</span> <span class="o">*</span> <span class="n">gdx</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">dL_dG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dL_dconic2D</span><span class="p">[</span><span class="n">global_id</span><span class="p">].</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5f</span> <span class="o">*</span> <span class="n">gdx</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">dL_dG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">atomicAdd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dL_dconic2D</span><span class="p">[</span><span class="n">global_id</span><span class="p">].</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5f</span> <span class="o">*</span> <span class="n">gdy</span> <span class="o">*</span> <span class="n">d</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">dL_dG</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Partial derivative of Loss w.r.t. opacity based on $α=oG$</p>
<p>$$ \frac{∂L}{∂o} = \frac{∂L}{∂α} ⋅ \frac{∂α}{∂o} = \frac{∂L}{∂α}⋅ G $$</p>
</li>
</ol>
<hr>
<h3 id="bw-cov2d">bw cov2D</h3>
<p>The cov2D $\bm Σ&rsquo;_{ray}$ is originated from the 3D covariance matrix 𝚺 and the mean vector 𝐱 (ie, 𝛍) in world space.
So the $\bm Σ&rsquo;_{ray}$ is the starting point of the derivative of Loss w.r.t. the 𝚺 and 𝐱 of each Gaussian.</p>
<p>To align notations in previous posts, the covariance matrix in <strong>ray</strong> space is dentoed as 𝚺&rsquo;,
and the cov matrix in <strong>world</strong> space is 𝚺.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 464 105"
      >
      <g transform='translate(8,16)'>
<path d='M 248,0 L 264,0' fill='none' stroke='currentColor'></path>
<path d='M 280,32 L 328,32' fill='none' stroke='currentColor'></path>
<path d='M 376,32 L 400,32' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 80,64' fill='none' stroke='currentColor'></path>
<path d='M 128,64 L 152,64' fill='none' stroke='currentColor'></path>
<path d='M 184,64 L 208,64' fill='none' stroke='currentColor'></path>
<path d='M 240,64 L 264,64' fill='none' stroke='currentColor'></path>
<path d='M 280,16 L 280,32' fill='none' stroke='currentColor'></path>
<path d='M 280,32 L 280,48' fill='none' stroke='currentColor'></path>
<polygon points='56.000000,64.000000 44.000000,58.400002 44.000000,69.599998' fill='currentColor' transform='rotate(180.000000, 48.000000, 64.000000)'></polygon>
<polygon points='136.000000,64.000000 124.000000,58.400002 124.000000,69.599998' fill='currentColor' transform='rotate(180.000000, 128.000000, 64.000000)'></polygon>
<polygon points='192.000000,64.000000 180.000000,58.400002 180.000000,69.599998' fill='currentColor' transform='rotate(180.000000, 184.000000, 64.000000)'></polygon>
<polygon points='248.000000,64.000000 236.000000,58.400002 236.000000,69.599998' fill='currentColor' transform='rotate(180.000000, 240.000000, 64.000000)'></polygon>
<polygon points='256.000000,0.000000 244.000000,-5.600000 244.000000,5.600000' fill='currentColor' transform='rotate(180.000000, 248.000000, 0.000000)'></polygon>
<polygon points='384.000000,32.000000 372.000000,26.400000 372.000000,37.599998' fill='currentColor' transform='rotate(180.000000, 376.000000, 32.000000)'></polygon>
<path d='M 264,0 A 16,16 0 0,1 280,16' fill='none' stroke='currentColor'></path>
<path d='M 280,48 A 16,16 0 0,1 264,64' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='84' fill='currentColor' style='font-size:1em'>w</text>
<text text-anchor='middle' x='8' y='84' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='16' y='68' fill='currentColor' style='font-size:1em'>𝐱</text>
<text text-anchor='middle' x='16' y='84' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='24' y='84' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='32' y='84' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='64' y='84' fill='currentColor' style='font-size:1em'>𝐑</text>
<text text-anchor='middle' x='96' y='84' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='104' y='68' fill='currentColor' style='font-size:1em'>𝐭</text>
<text text-anchor='middle' x='104' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='112' y='84' fill='currentColor' style='font-size:1em'>m</text>
<text text-anchor='middle' x='168' y='68' fill='currentColor' style='font-size:1em'>𝐉</text>
<text text-anchor='middle' x='192' y='84' fill='currentColor' style='font-size:1em'>𝐉</text>
<text text-anchor='middle' x='200' y='84' fill='currentColor' style='font-size:1em'>𝐑</text>
<text text-anchor='middle' x='208' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>w</text>
<text text-anchor='middle' x='216' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>𝚺</text>
<text text-anchor='middle' x='224' y='20' fill='currentColor' style='font-size:1em'>v</text>
<text text-anchor='middle' x='224' y='36' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='224' y='68' fill='currentColor' style='font-size:1em'>𝐓</text>
<text text-anchor='middle' x='232' y='20' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='232' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='240' y='20' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='240' y='36' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>𝐓</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>𝚺</text>
<text text-anchor='middle' x='312' y='20' fill='currentColor' style='font-size:1em'>𝐓</text>
<text text-anchor='middle' x='320' y='20' fill='currentColor' style='font-size:1em'>ᵀ</text>
<text text-anchor='middle' x='328' y='68' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='336' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='344' y='36' fill='currentColor' style='font-size:1em'>𝚺</text>
<text text-anchor='middle' x='344' y='52' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='344' y='68' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='352' y='36' fill='currentColor' style='font-size:1em'>'</text>
<text text-anchor='middle' x='352' y='52' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='360' y='68' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='368' y='68' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='376' y='68' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='408' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='416' y='36' fill='currentColor' style='font-size:1em'>𝚺</text>
<text text-anchor='middle' x='416' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='424' y='36' fill='currentColor' style='font-size:1em'>'</text>
<text text-anchor='middle' x='424' y='52' fill='currentColor' style='font-size:1em'>v</text>
<text text-anchor='middle' x='432' y='36' fill='currentColor' style='font-size:1em'>⁻</text>
<text text-anchor='middle' x='432' y='52' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='440' y='36' fill='currentColor' style='font-size:1em'>¹</text>
<text text-anchor='middle' x='440' y='52' fill='currentColor' style='font-size:1em'>D</text>
</g>

    </svg>
  
</div>
<p>Note:</p>
<ol>
<li>
<p>The clip coordinates <strong>aren&rsquo;t</strong> used in the conversion for the 3D covariance matrix from world space to ray space.
This is aligned with the EWA splatting.
As the Gaussian center&rsquo;s coordiantes are used in the Jacobian 𝐉, which is an approximation of perspective division,
where the camera-space coordinates are supposed to be used, the 𝐭 in 𝐉 is coordinates of Gaussian center in camera space.
So, only the <code>viewmatrix</code> &ldquo;w2c&rdquo; 𝐑 is applied to the world coordinates 𝐱.</p>
</li>
<li>
<p>However, the 2D Gaussian center on the screen indeed comes from clip coordinates,
because points outside the frustrum don&rsquo;t need to be rendered.
Therefore, the projection matrix <code>projmatrix</code> is applied to the world coordinates 𝐱.</p>
</li>
<li>
<p>The above two branches both are derived from the world coordinates 𝐱,
so the derivative of Loss w.r.t. 𝐱 ($\frac{∂L}{∂𝐱}$) comprises of two portions.</p>
</li>
</ol>
<hr>
<h4 id="dσdσ">dΣ&rsquo;⁻¹/dΣ'</h4>
<p>(2024-02-11)</p>
<p>So far, the derivative of loss w.r.t. the <strong>inverse</strong> (<code>conics</code>, $(\bm Σ&rsquo;)⁻¹$) of a 2D-plane covariance matrix $\bm Σ&rsquo;$
(i.e., the 3D cov in ray space with 3rd row and column omitted) has been obtained.
So, the derivative of loss w.r.t. the original 2D cov matrix 𝚺&rsquo; is
$\frac{∂L}{∂\bm Σ&rsquo;⁻¹}$ appended with the derivative of 𝚺&rsquo;⁻¹ w.r.t. 𝚺'.</p>
<p>Consider 4 variables a, b, c, d form the matrix $\bm Σ&rsquo; = \begin{bmatrix}a &amp; b \\ d &amp; c \end{bmatrix}$,
its inverse matrix is: $\bm Σ&rsquo;⁻¹ = \frac{1}{ac-bd} \begin{bmatrix} c &amp; -b \\ -d &amp; a \end{bmatrix}$, where b=d.</p>
<p>The partial derivatives of the inverse matrix w.r.t. each variable: a,b,c,d are:</p>
<p>$$
\begin{aligned}
\frac{∂ \bm Σ&rsquo;⁻¹}{∂a} &amp;= \frac{-c² + bc + dc - bd}{(ac-bd)²}, &amp;
\frac{∂ \bm Σ&rsquo;⁻¹}{∂b} &amp;= \frac{cd-ac-d²+ad}{(ac-bd)²} \\
\frac{∂ \bm Σ&rsquo;⁻¹}{∂c} &amp;= \frac{-bd+ba+da-a²}{(ac-bd)²}, &amp;
\frac{∂ \bm Σ&rsquo;⁻¹}{∂d} &amp;= \frac{cb-b²-ac+ab}{(ac-bd)²} \\
\end{aligned}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>  <span class="c1">// detminant
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">dL_da</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dL_db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dL_dc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">denom2inv</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="p">((</span><span class="n">denom</span> <span class="o">*</span> <span class="n">denom</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0000001f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_da</span> <span class="o">=</span> <span class="n">denom2inv</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">denom</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dc</span> <span class="o">=</span> <span class="n">denom2inv</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">a</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">denom</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_db</span> <span class="o">=</span> <span class="n">denom2inv</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">c</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">denom</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">dL_dconic</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="dσdσ-1">dΣ&rsquo;/dΣ</h4>
<p>(2024-02-12)</p>
<p><strong>Derivative of 3D covariance matrix from ray space to camera space:</strong></p>
<p>As the above 2D covariance matrix on plane is the 3D cov matrix 𝚺&rsquo; in the ray space with the 3rd row and column <strong>omitted</strong>.
Thus, the next step to be calculated is the conversion from 𝚺&rsquo; in the 3D ray space to 𝚺 in the world space.</p>
<p>The 3D covariance matrix 𝚺&rsquo; in the ray space is obtained after performing viewing transform and projective transform:</p>
<p>$$
\begin{aligned}
\bm Σ&rsquo;_{ray} &amp;= 𝐉⋅ 𝐑_{w2c} ⋅\bm Σ_{world}⋅ 𝐑ᵀ_{w2c} ⋅𝐉ᵀ  \\
\begin{bmatrix}
a &amp; b &amp; ∘ \\ b &amp; c &amp; ∘ \\ ∘ &amp; ∘ &amp; ∘
\end{bmatrix}
&amp;= \underbrace{
\begin{bmatrix}
\frac{f_x}{t_z} &amp; 0 &amp; -\frac{f_x t_x}{t_z^2} \\
0 &amp; \frac{f_y}{t_z} &amp; -\frac{f_y t_y}{t_z^2} \\
\frac{t_x}{‖𝐭‖} &amp; \frac{t_y}{‖𝐭‖} &amp; \frac{t_z}{‖𝐭‖}
\end{bmatrix}
\begin{bmatrix}
R_{11} &amp; R_{12} &amp; R_{13} \\ R_{21} &amp; R_{22} &amp; R_{23} \\ R_{31} &amp; R_{32} &amp; R_{33}
\end{bmatrix}
}_{T}
\begin{bmatrix}
v_0 &amp; v_1 &amp; v_2 \\
v_1 &amp; v_3 &amp; v_4 \\
v_2 &amp; v_4 &amp; v_5 \\
\end{bmatrix}
\underbrace{
\begin{bmatrix}
R_{11} &amp; R_{21} &amp; R_{31} \\ R_{12} &amp; R_{22} &amp; R_{32} \\ R_{13} &amp; R_{23} &amp; R_{33}
\end{bmatrix}
\begin{bmatrix}
\frac{f_x}{t_z} &amp; 0 &amp; \frac{t_x}{‖𝐭‖} \\
0 &amp; \frac{f_y}{t_z} &amp; \frac{t_y}{‖𝐭‖} \\
-\frac{f_x t_x}{t_z^2} &amp; -\frac{f_y t_y}{t_z^2} &amp; \frac{t_z}{‖𝐭‖}
\end{bmatrix}
}_{Tᵀ}
\\
&amp;= \begin{bmatrix}
T_{00} &amp; T_{01} &amp; T_{02} \\ T_{10} &amp; T_{11} &amp; T_{12} \\ T_{20} &amp; T_{21} &amp; T_{22} \\
\end{bmatrix}
\begin{bmatrix}
v_0 &amp; v_1 &amp; v_2 \\
v_1 &amp; v_3 &amp; v_4 \\
v_2 &amp; v_4 &amp; v_5 \\
\end{bmatrix}
\begin{bmatrix}
T_{00} &amp; T_{10} &amp; T_{20} \\ T_{01} &amp; T_{11} &amp; T_{21} \\ T_{02} &amp; T_{12} &amp; T_{22} \\
\end{bmatrix}
\end{aligned}
$$</p>
<p>The derivatives of 𝚺&rsquo; w.r.t. each element in the cov matrix $\bm Σ_{world}$ in world are:</p>
<p>$$
\begin{aligned}
\frac{∂\bm Σ&rsquo;_{ray}}{∂v_0} =
\begin{bmatrix} T_{00}T_{00} &amp; T_{00}T_{10} \\ T_{10}T_{00} &amp; T_{10}T_{10} \end{bmatrix}
\frac{∂\bm Σ&rsquo;_{ray}}{∂v_1} =
\begin{bmatrix} T_{00}T_{01} &amp; T_{00}T_{11} \\ T_{10}T_{01} &amp; T_{10}T_{11} \end{bmatrix}
\frac{∂\bm Σ&rsquo;_{ray}}{∂v_2} =
\begin{bmatrix} T_{00}T_{02} &amp; T_{00}T_{12} \\ T_{10}T_{02} &amp; T_{10}T_{12} \end{bmatrix} \\
\frac{∂\bm Σ&rsquo;_{ray}}{∂v_3} =
\begin{bmatrix} T_{01}T_{01} &amp; T_{01}T_{11} \\ T_{11}T_{01} &amp; T_{11}T_{11} \end{bmatrix}
\frac{∂\bm Σ&rsquo;_{ray}}{∂v_4} =
\begin{bmatrix} T_{01}T_{02} &amp; T_{01}T_{12} \\ T_{11}T_{02} &amp; T_{11}T_{12} \end{bmatrix} \\
\frac{∂\bm Σ&rsquo;_{ray}}{∂v_5} =
\begin{bmatrix} T_{02}T_{02} &amp; T_{02}T_{12} \\ T_{12}T_{02} &amp; T_{12}T_{12} \end{bmatrix}
\end{aligned}
$$</p>
<ul>
<li>
<p>Trick: Just find out the terms involving $v_0, v_1, v_2, v_3, v_4, v_5$</p>
<p>For example, in the first matmul, the <strong>coefficients</strong> applied on v₀ are $T_{00},\ T_{10},\ T_{20}$ (a row).
Then, in the outer matmul, the coefficients that multiplis with $v_0$ are $T_{00},\ T_{10},\ T_{20}$ (a column).</p>
<p>So, the row and the column form a matrix:</p>
<p>$$
\begin{bmatrix} T_{00} \\ T_{10} \\ T_{20} \end{bmatrix}
\begin{bmatrix} T_{00} &amp; T_{10} &amp; T_{20} \end{bmatrix} →
\begin{bmatrix}
T_{00}T_{00} &amp; T_{00}T_{10} &amp; T_{00}T_{20} \\
T_{10}T_{00} &amp; T_{10}T_{10} &amp; T_{10}T_{20} \\
T_{20}T_{00} &amp; T_{20}T_{10} &amp; T_{20}T_{20}
\end{bmatrix}
$$</p>
<p>The 3-rd row and column are omitted to yield the 2D covariance matrix on plane.</p>
<p>Since the upstream derivative of loss w.r.t. $\bm Σ&rsquo;_{ray}$ is a matrix as well,
they need to do <strong>element-wise</strong> multiplication:</p>
<p>$$
\begin{aligned}
\frac{∂L}{∂v_0} &amp;=
\begin{bmatrix}
\frac{∂L}{∂a} &amp; \frac{∂L}{∂b} \\ \frac{∂L}{∂b} &amp; \frac{∂L}{∂c}
\end{bmatrix} ⊙
\begin{bmatrix}
T_{00}T_{00} &amp; T_{00}T_{10} \\
T_{10}T_{00} &amp; T_{10}T_{10}
\end{bmatrix} \\ &amp;=
\begin{bmatrix}
\frac{∂L}{∂a} T_{00}T_{00} &amp; \frac{∂L}{∂b} T_{00}T_{10} \\
\frac{∂L}{∂b} T_{10}T_{00} &amp; \frac{∂L}{∂c} T_{10}T_{10}
\end{bmatrix}
\end{aligned}
$$</p>
<p>As loss is a scalar, the derivative of the loss w.r.t. $v_0$ should be the summation of all elements in the matrix (Need reference❗):</p>
<p>$$
\frac{∂L}{∂v_0} =
\frac{∂L}{∂a} T_{00}T_{00} + 2× \frac{∂L}{∂b}T_{00}T_{10} + \frac{∂L}{∂c} T_{10}T_{10}
$$</p>
</li>
</ul>
<ul>
<li>
<details><summary>Details for v₄</summary>
<p>Similarly, the coefficients related to $v_4$ are the 3rd row of the right matrix 𝐓ᵀ, and the 2nd column of the left matrix 𝐓.</p>
<p>$$
\begin{bmatrix} T_{01} \\ T_{11} \\ T_{21} \end{bmatrix}
\begin{bmatrix} T_{02} &amp; T_{12} &amp; T_{22} \end{bmatrix} →
\begin{bmatrix}
T_{01}T_{02} &amp; T_{01}T_{12} &amp; T_{01}T_{22} \\
T_{11}T_{02} &amp; T_{11}T_{12} &amp; T_{11}T_{22} \\
T_{21}T_{02} &amp; T_{21}T_{12} &amp; T_{21}T_{22} \\
\end{bmatrix}
$$</p>
<p>The derivative of loss w.r.t. $v_1$</p>
<p>$$
\begin{aligned}
\frac{∂L}{∂v_1} &amp;=
\begin{bmatrix}
\frac{∂L}{∂a} &amp; \frac{∂L}{∂b} \\ \frac{∂L}{∂b} &amp; \frac{∂L}{∂c}
\end{bmatrix} ⊙
\begin{bmatrix} T_{01}T_{02} &amp; T_{01}T_{12} \\ T_{11}T_{02} &amp; T_{11}T_{12} \end{bmatrix} \\
&amp;= T_{01}T_{02} \frac{∂L}{∂a} + (T_{01}T_{12} + T_{11}T_{02})\frac{∂L}{∂b} + T_{11}T_{12}\frac{∂L}{∂c}
\end{aligned}
$$</p>
<p>Because the covariance matrix is symmatric (<code>cov[1][2]=cov[2][1]</code>), the effect attributed to the change of $v_1$ should double.</p>
<p>$$ \frac{∂L}{∂v_4} =
2×T_{01}T_{02} \frac{∂L}{∂a} + 2×(T_{01}T_{12} + T_{11}T_{02})\frac{∂L}{∂b} + 2×T_{11}T_{12}\frac{∂L}{∂c} $$</p>
</details>
</li>
<li>
<p>In the 3DGS <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/backward.cu#L214-L227"  target="_blank" rel="noopener"
    >code</a>, <code>dL_db</code> had doubled.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">glm</span><span class="o">::</span><span class="n">mat3</span> <span class="n">T</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="n">J</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dcov</span><span class="p">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_db</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dcov</span><span class="p">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_db</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dcov</span><span class="p">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_db</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dcov</span><span class="p">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dL_db</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dcov</span><span class="p">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">dL_db</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dcov</span><span class="p">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">dL_db</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dc</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h4 id="dσdt">dΣ&rsquo;/dT</h4>
<p>(2024-02-13)</p>
<p>To solve the derivative of Loss w.r.t. $𝐭$ (in camera space), the chain is:</p>
<p>$$\frac{∂L}{∂t} = \frac{∂L}{\bm Σ&rsquo;_{ray}} \frac{∂\bm Σ&rsquo;_{ray}}{∂T} \frac{∂T}{∂J} \frac{∂J}{∂t}$$</p>
<p>The derivative of Loss w.r.t. 2D $\bm Σ&rsquo;_{ray}$ has been obtained earlier.
The next step is to calculate $\frac{∂\bm Σ&rsquo;_{ray}}{∂T}$, where all variables except for T are treated as <strong>constants</strong>.</p>
<p>Based on the relationship:</p>
<p>$$
\bm Σ&rsquo;_{ray} = 𝐓⋅\bm Σ_{world}⋅𝐓ᵀ \\
= \begin{bmatrix} T_{00} &amp; T_{01} &amp; T_{02} \\ T_{10} &amp; T_{11} &amp; T_{12} \\ T_{20} &amp; T_{21} &amp; T_{22} \end{bmatrix}
\begin{bmatrix} v_{00} &amp; v_{01} &amp; v_{02} \\ v_{10} &amp; v_{11} &amp; v_{12} \\ v_{20} &amp; v_{21} &amp; v_{22} \end{bmatrix}
\begin{bmatrix} T_{00} &amp; T_{10} &amp; T_{20} \\ T_{01} &amp; T_{11} &amp; T_{21} \\ T_{02} &amp; T_{12} &amp; T_{22} \end{bmatrix}
$$</p>
<p>Represent the matrix $\bm Σ&rsquo;_{ray}$ as a single <strong>generic term</strong> with varying indices:
(inspired by <a class="link" href="https://youtu.be/ny-i8_9NtHA?si=dLgVcGo_FEkVsv0w"  target="_blank" rel="noopener"
    >David Levin</a>
surfaced by <a class="link" href="https://www.perplexity.ai/search/Can-the-CUDA-ntG2eOR.QZu4LeOSCl5XNw?s=u"  target="_blank" rel="noopener"
    >perplexity</a>)</p>
<ul>
<li>an element in the result of $\bm Σ_{world}⋅𝐓ᵀ$ is $q$;</li>
<li>an element in the $\bm Σ&rsquo;_{ray}$ is $p$</li>
</ul>
<p>$$
\begin{aligned}
q_{ij} &amp;= ∑ₖ₌₀² v_{ik} T_{jk} \\
p_{mn} &amp;= ∑ₛ₌₀² T_{ms} q_{sn} = ∑ₛ₌₀² T_{ms} ∑ₖ₌₀² v_{sk} T_{nk}\\
\bm Σ&rsquo;_{ray} &amp;= \begin{bmatrix} p_{00} &amp; p_{01} &amp; p_{02} \\ p_{10} &amp; p_{11} &amp; p_{12} \\ p_{20} &amp; p_{21} &amp; p_{22} \end{bmatrix}
\end{aligned}
$$</p>
<p>Expand each $p_{mn}$:</p>
<p>$$
\begin{array}{ccc}
\begin{aligned}
p_{00} =&amp; T_{00}(v_{00}T_{00} + v_{01}T_{01} + v_{02}T_{02}) \\
+&amp; T_{01}(v_{10}T_{00} + v_{11}T_{01} + v_{12}T_{02}) \\
+&amp; T_{02}(v_{20}T_{00} + v_{21}T_{01} + v_{22}T_{02}) \\
\end{aligned}
&amp;
\begin{aligned}
p_{01} =&amp; T_{00}(v_{00}T_{10} + v_{01}T_{11} + v_{02}T_{12}) \\
+&amp; T_{01}(v_{10}T_{10} + v_{11}T_{11} + v_{12}T_{12}) \\
+&amp; T_{02}(v_{20}T_{10} + v_{21}T_{11} + v_{22}T_{12}) \\
\end{aligned}
&amp;
\begin{aligned}
p_{02} =&amp; T_{00}(v_{00}T_{20} + v_{01}T_{21} + v_{02}T_{22}) \\
+&amp; T_{01}(v_{10}T_{20} + v_{11}T_{21} + v_{12}T_{22}) \\
+&amp; T_{02}(v_{20}T_{20} + v_{21}T_{21} + v_{22}T_{22}) \\
\end{aligned}
\\
\begin{aligned}
p_{10} =&amp; T_{10}(v_{00}T_{00} + v_{01}T_{01} + v_{02}T_{02}) \\
+&amp; T_{11}(v_{10}T_{00} + v_{11}T_{01} + v_{12}T_{02}) \\
+&amp; T_{12}(v_{20}T_{00} + v_{21}T_{01} + v_{22}T_{02}) \\
\end{aligned}
&amp; p_{11} &amp; p_{12} \\
\begin{aligned}
p_{20} =&amp; T_{20}(v_{00}T_{00} + v_{01}T_{01} + v_{02}T_{02}) \\
+&amp; T_{21}(v_{10}T_{00} + v_{11}T_{01} + v_{12}T_{02}) \\
+&amp; T_{22}(v_{20}T_{00} + v_{21}T_{01} + v_{22}T_{02}) \\
\end{aligned}
&amp; p_{21} &amp; p_{22}
\end{array}
$$</p>
<p>The 3-rd row and column are omitted to become the 2x2 $\bm Σ&rsquo;_{ray}$.
So, only 4 elements affect the derivative of the $\bm Σ&rsquo;_{ray}$.
For example, the derivative of $\bm Σ&rsquo;_{ray}$ w.r.t. $T₀₀$ only related to components containing $T_{00}$.</p>
<p>Calculate the derivative of each element $p_{mn}$ in the $\bm Σ&rsquo;_{ray}$ w.r.t. $T_{00}$. A matrix is assembled:</p>
<p>$$
\begin{bmatrix}
\frac{∂p_{00}}{∂T_{00}} &amp; \frac{∂p_{01}}{∂T_{00}} \\
\frac{∂p_{10}}{∂T_{00}} &amp; \frac{∂p_{11}}{∂T_{00}}
\end{bmatrix} =
\begin{bmatrix}
\substack{2T_{00}v_{00} + v_{01}T_{01} + v_{02}T_{02} \\ + T_{01}v_{10} + T_{02}v_{20} }
&amp; v_{00}T_{10} + v_{01}T_{11} + v_{02}T_{12} \\
T_{10}v_{00} + T_{11}v_{10} + T_{12}v_{20} &amp; 0
\end{bmatrix}
$$</p>
<p>Therefore, the derivative of the scalar Loss w.r.t. T₀₀, i.e., $\frac{∂L}{∂T₀₀}$, is also a matrix:</p>
<p>$$
\frac{∂L}{∂T_{00}} =
\frac{∂L}{∂\bm Σ&rsquo;_{ray}}⊙  \frac{∂\bm Σ&rsquo;_{ray}}{∂T_{00}} =
\begin{bmatrix}
\frac{∂L}{∂a} (2(T_{00}v_{00}+T_{01}v_{01}+T_{02}v_{02})) &amp;
\frac{∂L}{∂b} (T_{10}v_{00}+T_{11}v_{01}+T_{12}v_{02} ) \\
\frac{∂L}{∂b} (T_{10}v_{00}+T_{11}v_{10}+T_{12}v_{20} ) &amp; 0
\end{bmatrix}
$$</p>
<p>As the loss $L$ is a scalar, the derivative of $L$ w.r.t. a certain variable (e.g., T₀₀) is
the total <strong>quantity</strong> of changes in all elements of a matrix caused by that variable&rsquo;s unit perturbation.
Thus, $\frac{∂L}{∂T₀₀}$ is a sum of all elements in the final &ldquo;derivative matrix&rdquo; of Loss w.r.t. T₀₀:</p>
<p>$$
\frac{∂L}{∂T_{00}} = \frac{∂L}{∂a}(2(T_{00}v_{00}+T_{01}v_{01}+T_{02}v_{02}) ) + \frac{∂L}{∂b}(2(T_{10}v_{00}+T_{11}v_{01}+T_{12}v_{02} ) )
$$</p>
<details><summary>Tricks for identifying necessary terms</summary>
<p>Only focus on the terms that includes $T_{00}$:</p>
<ol>
<li>
<p>For the first matmul between $\bm Σ_{world}$ and 𝐓ᵀ,
the full 1st row will be kept as it will times a $T_{00}$ during the second matmul,
and additional 2 terms containing $T_{00}$ are left:</p>
<p>$$\begin{matrix}
v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}
&amp; v₀₀T_{10} + v_{01}T_{11} + v_{02}T_{12}
&amp; v₀₀T_{20} + v_{01}T_{21} + v_{02}T_{22} \\
v_{10} T_{00} \\ v_{20} T_{00}
\end{matrix}$$</p>
<ul>
<li>I disregard unrelated terms, to which the derivatives with respect are 0.</li>
</ul>
</li>
<li>
<p>Then, applying the left 𝐓</p>
<p>$$
\begin{aligned}
\bm Σ&rsquo;_{ray}&amp;=
\begin{bmatrix} T_{00} &amp; T_{01} &amp; T_{02} \\
T_{10} &amp; T_{11} &amp; T_{12} \\
T_{20} &amp; T_{21} &amp; T_{22} \end{bmatrix}
\begin{bmatrix} v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}
&amp; v₀₀T_{10} + v_{01}T_{11} + v_{02}T_{12}
&amp; v₀₀T_{20} + v_{01}T_{21} + v_{02}T_{22} \\
v_{10} T_{00} \\ v_{20} T_{00} \end{bmatrix} \\
&amp;=
\begin{bmatrix}
T_{00} (v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}) + T_{01} v_{10} T_{00} + T_{02} v_{20} T_{00}
&amp; T_{00} (v₀₀T_{10} + v_{01}T_{11} + v_{02}T_{12})
&amp; T_{00} (v₀₀T_{20} + v_{01}T_{21} + v_{02}T_{22}) \\
T_{10} (v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}) + T_{11} v_{10} T_{00} + T_{12} v_{20} T_{00} \\
T_{20} (v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}) + T_{21} v_{10} T_{00} + T_{22} v_{20} T_{00}
\end{bmatrix}
\end{aligned}
$$</p>
<p>As the 3rd row and column don&rsquo;t appear in the 2D plane cov matrix $\bm Σ&rsquo;_{ray}$,
only 4 terms contribute to the derivative of L w.r.t. $T₀₀$:</p>
<p>$$\begin{bmatrix}
T_{00} (v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}) + T_{01} v_{10} T_{00} + T_{02} v_{20} T_{00}
&amp; T_{00} (v₀₀T_{10} + v_{01}T_{11} + v_{02}T_{12}) \\
T_{10} (v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}) + T_{11} v_{10} T_{00} + T_{12} v_{20} T_{00}
\end{bmatrix}$$</p>
</li>
<li>
<p>Compute derivative of each element w.r.t. $T_{00}$:</p>
<p>$$\begin{bmatrix}
2(v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02}) &amp; v₀₀T_{10} + v_{01}T_{11} + v_{02}T_{12} \\
T_{10}v₀₀ + T_{11} v_{10} + T_{12} v_{20}
\end{bmatrix}$$</p>
</li>
<li>
<p>Combine with $\frac{∂L}{∂\bm Σ&rsquo;_{ray}}$ by element-wise product to get the ultimate &ldquo;derivative matrix&rdquo; of Loss w.r.t T₀₀.</p>
<p>$$\frac{∂L}{∂T₀₀} = \begin{bmatrix}
\frac{∂L}{∂a} ⋅ 2(v₀₀T_{00} + v_{01}T_{01} + v_{02}T_{02})
&amp; \frac{∂L}{∂b} (v₀₀T_{10} + v_{01}T_{11} + v_{02}T_{12}) \\
\frac{∂L}{∂b} (T_{10}v₀₀ + T_{11} v_{10} + T_{12} v_{20})
\end{bmatrix}$$</p>
<p>Finally, as L is a scalar, the derivative of L w.r.t. T₀₀ is the sum of all derivatives of each element in the &ldquo;derivative matrix&rdquo;.</p>
</li>
</ol>
</details>
<p>The <code>dL_db</code> in <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/backward.cu#L237-L248"  target="_blank" rel="noopener"
    >3DGS Code</a> had <strong>doubled</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">dL_dT00</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vrk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vrk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vrk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">dL_da</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vrk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vrk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">Vrk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">dL_db</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Similarly, the derivatives of Loss w.r.t. T₀₁, T₀₂, T₁₀, T₁₁, T₁₂ can be obtained.
As T₂₀, T₂₁, T₂₂ are not involved in the 2D $\bm Σ&rsquo;_{ray}$, they don&rsquo;t contribute the derivative of $\bm Σ&rsquo;_{ray}$.</p>
<p>$$
\frac{∂L}{∂𝐓} =
\begin{bmatrix}
\frac{∂L}{∂T_{00}} &amp; \frac{∂L}{∂T_{01}} &amp; \frac{∂L}{∂T_{02}} \\
\frac{∂L}{∂T_{10}} &amp; \frac{∂L}{∂T_{11}} &amp; \frac{∂L}{∂T_{12}} \\
0 &amp; 0 &amp; 0
\end{bmatrix}
$$</p>
<hr>
<h4 id="dtdj">dT/dJ</h4>
<p>(2024-02-14)</p>
<p>Based on the relationship:</p>
<p>$$
𝐓 = 𝐉𝐖 =
\begin{bmatrix}
J₀₀ &amp; J₀₁ &amp; J₀₂ \\
J₁₀ &amp; J₁₁ &amp; J₁₂ \\
J₂₀ &amp; J₂₁ &amp; J₂₂
\end{bmatrix}
\begin{bmatrix}
W₀₀ &amp; W₀₁ &amp; W₀₂ \\
W₁₀ &amp; W₁₁ &amp; W₁₂ \\
W₂₀ &amp; W₂₁ &amp; W₂₂
\end{bmatrix}
$$</p>
<p>The derivative of 𝐓 w.r.t. $J₀₀$</p>
<p>$$
\frac{∂T}{∂J_{00}} =
\begin{bmatrix} W₀₀ &amp; W₀₁ &amp; W₀₂ \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 \end{bmatrix}
$$</p>
<p>The &ldquo;derivative matrix&rdquo; of Loss w.r.t. $J₀₀$</p>
<p>$$
\frac{∂L}{∂T} ⊙ \frac{∂T}{∂J_{00}} =
\begin{bmatrix}
\frac{∂L}{∂T_{00}} &amp; \frac{∂L}{∂T_{01}} &amp; \frac{∂L}{∂T_{02}} \\
\frac{∂L}{∂T_{10}} &amp; \frac{∂L}{∂T_{11}} &amp; \frac{∂L}{∂T_{12}}
\end{bmatrix}
⊙ \begin{bmatrix} W₀₀ &amp; W₀₁ &amp; W₀₂ \\ 0 &amp; 0&amp;0 \end{bmatrix} \\ =
\begin{bmatrix}
\frac{∂L}{∂T_{00}} W₀₀ &amp; \frac{∂L}{∂T_{01}} W₀₁ &amp; \frac{∂L}{∂T_{02}} W₀₂ \\ 0 &amp; 0 &amp; 0 \end{bmatrix}
$$</p>
<p>The derivative of Loss w.r.t. J₀₀ is the sum of all elements in the &ldquo;derivative matrix&rdquo;:</p>
<p>$$
\frac{∂L}{∂J₀₀} = \frac{∂L}{∂T_{00}} W₀₀ + \frac{∂L}{∂T_{01}} W₀₁ + \frac{∂L}{∂T_{02}} W₀₂
$$</p>
<p>In <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/backward.cu#L252-L255"  target="_blank" rel="noopener"
    >3DGS code</a>,
the 3-rd row of the Jacobian matrix is set to 0 (as opacity isn&rsquo;t obtained by integration along z-axis of ray space, but learned),
thus no contribution to the derivative of Loss.
Only compute the derivative of Loss w.r.t. J₀₀, J₀₂, J₁₁, J₁₂</p>
<p>$$
\frac{∂L}{∂𝐉} =
\begin{bmatrix} \frac{∂L}{∂J₀₀} &amp; 0 &amp; \frac{∂L}{∂J₀₂} \\
0 &amp; \frac{∂L}{J₁₁} &amp; \frac{∂L}{∂₁₂}
\end{bmatrix}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">dL_dJ00</span> <span class="o">=</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dT00</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dT01</span> <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dL_dT02</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="djdt">dJ/dt</h4>
<p>The 3D mean 𝐭 in 𝐉 is the coordinates of a Gaussian center in <strong>camera</strong> space,
<strong>Not</strong> the clip space, whereas the 2D mean 𝛍 indeed originates from the <strong>clip</strong> coordinates.
Clip space is the <strong>scaled</strong> camera space for frustum clipping,
and it&rsquo;ll lead to 2D-plane projection coordinates (x,y) ranging in [-1,1].
However, the 𝐭 in 𝐉 must be camera-space coordinates, instead of the clip coordinates,
because the perspective division approximated by the Jacobian 𝐉 uses coordinates of the 3D mean in camera space.</p>
<p>The 𝐉 is the projective <strong>transform</strong> that transforms a point to 3D ray space (screen is the ray space with z-axis omitted).
𝐉 is an approximation of the non-linear perspective division with the 1st-order Taylor expansion evaluated at the 3D Gaussian center 𝐭 in camera space.</p>
<p>In 3DGS, the 3rd row of 𝐉 is set to 0, as the opacity of each Gaussian is <strong>learned</strong> through gradient descent,
instead of an integral over the viewing ray in the ray space.
Thus, the z-axis of the ray space is useless in 3DGS.</p>
<p>Based on the relationship:</p>
<p>$$
𝐉 = \begin{bmatrix}
f_x/t_z &amp; 0 &amp; -f_x t_x / t_z² \\ 0 &amp; f_y/t_z &amp; -f_y t_y/t_z² \\ 0 &amp; 0 &amp; 0
\end{bmatrix}
$$</p>
<p>The derivatives of 𝐉 w.r.t. $t_x,\ t_y,\ t_z$:</p>
<p>$$
\begin{aligned}
\frac{∂𝐉}{∂t_x} &amp;=
\begin{bmatrix}0 &amp; 0 &amp; -f_x / t_z² \\ 0 &amp; 0 &amp; 0 \end{bmatrix} \\
\frac{∂𝐉}{∂t_y} &amp;=
\begin{bmatrix}0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; -f_y / t_z²\end{bmatrix} \\
\frac{∂𝐉}{∂t_z} &amp;=
\begin{bmatrix}
-f_x⋅t_z^{-1} &amp; 0 &amp; 2f_x t_x ⋅t_z^{-3} \\
0 &amp; -f_y⋅t_z^{-1} &amp; 2f_y t_y ⋅t_z^{-3} \\
\end{bmatrix}
\end{aligned}
$$</p>
<p>Combine upstream coefficients:</p>
<p>$$
\begin{aligned}
\frac{∂L}{∂t_x} &amp;= \frac{∂L}{∂𝐉}⊙ \frac{∂𝐉}{∂t_x} = \frac{∂L}{∂J_{02}} ⋅ -f_x/t_z^2
\\
\frac{∂L}{∂t_y} &amp;= \frac{∂L}{∂𝐉}⊙ \frac{∂𝐉}{∂t_y} = \frac{∂L}{∂J_{12}} ⋅ -f_y/t_z^2
\\
\frac{∂L}{∂t_z} &amp;= \frac{∂L}{∂𝐉}⊙ \frac{∂𝐉}{∂t_z} =
\begin{bmatrix}
\frac{∂L}{∂J₀₀} &amp; 0 &amp; \frac{∂L}{∂J₀₂} \\
0 &amp; \frac{∂L}{J₁₁} &amp; \frac{∂L}{∂₁₂}
\end{bmatrix} ⊙
\begin{bmatrix}
-f_x⋅t_z^{-2} &amp; 0 &amp; 2f_x t_x ⋅t_z^{-3} \\
0 &amp; -f_y⋅t_z^{-2} &amp; 2f_y t_y ⋅t_z^{-3} \\
\end{bmatrix}
\\
&amp;= \begin{bmatrix}
\frac{∂L}{∂J₀₀} ⋅-f_x⋅t_z^{-2} &amp; 0 &amp; \frac{∂L}{∂J₀₂}⋅ 2f_x t_x ⋅t_z^{-3} \\
0 &amp; \frac{∂L}{J₁₁} ⋅-f_y⋅t_z^{-2} &amp; \frac{∂L}{∂₁₂} ⋅2f_y t_y ⋅t_z^{-3}
\end{bmatrix}
\end{aligned}
$$</p>
<p><a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/backward.cu#L262-L264"  target="_blank" rel="noopener"
    >Code</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// h_x and h_y are f_x and f_y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">float</span> <span class="n">dL_dtx</span> <span class="o">=</span> <span class="n">x_grad_mul</span> <span class="o">*</span> <span class="o">-</span><span class="n">h_x</span> <span class="o">*</span> <span class="n">tz2</span> <span class="o">*</span> <span class="n">dL_dJ02</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">dL_dty</span> <span class="o">=</span> <span class="n">y_grad_mul</span> <span class="o">*</span> <span class="o">-</span><span class="n">h_y</span> <span class="o">*</span> <span class="n">tz2</span> <span class="o">*</span> <span class="n">dL_dJ12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">dL_dtz</span> <span class="o">=</span> <span class="o">-</span><span class="n">h_x</span> <span class="o">*</span> <span class="n">tz2</span> <span class="o">*</span> <span class="n">dL_dJ00</span> <span class="o">-</span> <span class="n">h_y</span> <span class="o">*</span> <span class="n">tz2</span> <span class="o">*</span> <span class="n">dL_dJ11</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h_x</span> <span class="o">*</span> <span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">tz3</span> <span class="o">*</span> <span class="n">dL_dJ02</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h_y</span> <span class="o">*</span> <span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">tz3</span> <span class="o">*</span> <span class="n">dL_dJ12</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="dtdx">dt/dx</h4>
<p>After the projective transform, the derivative of $𝐭$ (Gaussian center coordinates) in camera space w.r.t. $𝐱$ in world space follows.</p>
<p>Based on the relationship of w2c <code>viewmatrix</code>:</p>
<p>$$
\begin{aligned}
𝐭_{cam} &amp;= 𝐑_{w2c}⋅𝐱_{world} + 𝐓_{w2c} \\
&amp;=\begin{bmatrix}
R₀₀ &amp; R₀₁ &amp; R₀₂ \\
R₁₀ &amp; R₁₁ &amp; R₁₂ \\
R₂₀ &amp; R₂₁ &amp; R₂₂
\end{bmatrix}
\begin{bmatrix} x \\ y \\ z \end{bmatrix} +
\begin{bmatrix} T_0 \\ T_1 \\ T_2 \end{bmatrix} \\
&amp;=\begin{bmatrix}
R₀₀x + R₀₁y + R₀₂z + T_0 \\
R₁₀x + R₁₁y + R₁₂z + T_1 \\
R₂₀x + R₂₁y + R₂₂z + T_2
\end{bmatrix}
\end{aligned}
$$</p>
<p>The derivative of $𝐭_{cam}$ w.r.t. $x, y, z$ of $𝐱_{world}$ are:</p>
<p>$$
\frac{∂𝐭}{∂x} = \begin{bmatrix} R₀₀\\ R₁₀\\ R₂₀ \end{bmatrix},
\frac{∂𝐭}{∂y} = \begin{bmatrix} R₀₁\\ R₁₁\\ R₂₁ \end{bmatrix},
\frac{∂𝐭}{∂z} = \begin{bmatrix} R₀₂\\ R₁₂\\ R₂₂ \end{bmatrix}
$$</p>
<p>The derivative of $L$ w.r.t. $x, y, z$ of $𝐱_{world}$ are:</p>
<p>$$
\frac{∂L}{∂𝐭} \frac{∂𝐭}{∂x} = \frac{∂L}{∂t_x}\begin{bmatrix} R₀₀\\ R₁₀\\ R₂₀ \end{bmatrix},
\frac{∂L}{∂𝐭} \frac{∂𝐭}{∂y} = \frac{∂L}{∂t_y}\begin{bmatrix} R₀₁\\ R₁₁\\ R₂₁ \end{bmatrix},
\frac{∂L}{∂𝐭} \frac{∂𝐭}{∂z} = \frac{∂L}{∂t_z}\begin{bmatrix} R₀₂\\ R₁₂\\ R₂₂ \end{bmatrix}
$$</p>
<p>As the x, y, z are individual variables to be optimized, the derivatives of L w.r.t. each of them shouldn&rsquo;t add up.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">__forceinline__</span> <span class="n">__device__</span> <span class="n">float3</span> <span class="nf">transformPoint4x3</span><span class="p">(</span><span class="k">const</span> <span class="n">float3</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span><span class="o">*</span> <span class="n">matrix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">float3</span> <span class="n">transformed</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">matrix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">transformed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="bw-preprocess">bw preprocess</h3>
<p>(2024-02-15)</p>
<p>The preprocess performed conversions from SH to RGB, from quaternion to a 3x3 rotation matrix,
and from a stretching vector to the 3x3 covariance matrix in the world space.</p>
<p>Therefore, the inputs to the function <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/backward.cu#L347-L364"  target="_blank" rel="noopener"
    ><code>BACKWARD::preprocessCUDA</code></a>
are the derivatives of Loss w.r.t. upstream variables: $\frac{∂L}{∂(RGB)},\ \frac{∂L}{∂\bm Σ_{world}},\ \frac{∂L}{∂𝐱_{world}},\ \frac{∂L}{∂\bm μ_{2D}}$.
to solve the derivatives of Loss w.r.t. stretching vector, quaternion, and SH coeffs.</p>
<hr>
<h4 id="d_pixd_world">d_pix/d_world</h4>
<p>(2024-02-16)</p>
<p>Gaussian center transformation from world space to 2D screen:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 272 73"
      >
      <g transform='translate(8,16)'>
<path d='M 64,16 L 88,16' fill='none' stroke='currentColor'></path>
<path d='M 152,16 L 208,16' fill='none' stroke='currentColor'></path>
<polygon points='72.000000,16.000000 60.000000,10.400000 60.000000,21.600000' fill='currentColor' transform='rotate(180.000000, 64.000000, 16.000000)'></polygon>
<polygon points='160.000000,16.000000 148.000000,10.400000 148.000000,21.600000' fill='currentColor' transform='rotate(180.000000, 152.000000, 16.000000)'></polygon>
<text text-anchor='middle' x='0' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='8' y='36' fill='currentColor' style='font-size:1em'>μ</text>
<text text-anchor='middle' x='8' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='16' y='36' fill='currentColor' style='font-size:1em'>ₓ</text>
<text text-anchor='middle' x='16' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='24' y='20' fill='currentColor' style='font-size:1em'>𝛍</text>
<text text-anchor='middle' x='24' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='24' y='52' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>μ</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='48' y='52' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='36' fill='currentColor' style='font-size:1em'>)</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>v</text>
<text text-anchor='middle' x='112' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>𝛍</text>
<text text-anchor='middle' x='120' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>ᶜ</text>
<text text-anchor='middle' x='128' y='52' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='136' y='52' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='168' y='4' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='176' y='4' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='184' y='4' fill='currentColor' style='font-size:1em'>j</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>M</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>(</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='216' y='52' fill='currentColor' style='font-size:1em'>w</text>
<text text-anchor='middle' x='224' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='224' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='232' y='20' fill='currentColor' style='font-size:1em'>𝐱</text>
<text text-anchor='middle' x='232' y='36' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='232' y='52' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='240' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='240' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='248' y='36' fill='currentColor' style='font-size:1em'>z</text>
<text text-anchor='middle' x='248' y='52' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='256' y='36' fill='currentColor' style='font-size:1em'>)</text>
</g>

    </svg>
  
</div>
<p>The derivative of Loss w.r.t. the 3D Gaussian mean 𝐱 in world space comprises of 2 streams:</p>
<p>$$\frac{∂L}{∂𝐱} = \frac{∂L}{∂𝐉} \frac{∂𝐉}{∂𝐱} + \frac{∂L}{∂\bm μ} \frac{∂\bm μ}{∂𝐱}
$$</p>
<p>The first term resulted from 𝐉 has been obtained above,
and the relationship between the 2D mean 𝛍 on screen and 3D 𝐱 is the <a class="link" href="https://github.com/graphdeco-inria/gaussian-splatting/blob/2eee0e26d2d5fd00ec462df47752223952f6bf4e/scene/cameras.py#L56"  target="_blank" rel="noopener"
    ><code>full_proj_transform</code></a>
, i.e., projection matrix @ w2c</p>
<p>$$
\begin{aligned}
\bm μᶜ &amp;= 𝐏 [𝐑|𝐓] 𝐱 \\
\begin{bmatrix}
μᶜ_x \\ μᶜ_y \\ μᶜ_z \\ μᶜ_w
\end{bmatrix} &amp;=
\begin{bmatrix}
\frac{2n}{r-l} &amp; 0 &amp; \frac{r+l}{r-l} &amp; 0 \\
0 &amp; \frac{2n}{t-b} &amp; \frac{t+b}{t-b} &amp; 0 \\
0 &amp; 0 &amp; \frac{f}{f-n} &amp; \frac{-f n}{f-n} \\
0 &amp; 0 &amp; 1 &amp; 0
\end{bmatrix}
\begin{bmatrix}
R₀₀ &amp; R₀₁ &amp; R₀₂ &amp; T₀ \\
R₁₀ &amp; R₁₁ &amp; R₁₂ &amp; T₁ \\
R₂₀ &amp; R₂₁ &amp; R₂₂ &amp; T₂ \\
0   &amp; 0   &amp; 0   &amp; 1
\end{bmatrix}
\begin{bmatrix}
x \\ y \\ z \\ 1
\end{bmatrix} \\
&amp;=
\begin{bmatrix}
\frac{2n}{r-l} R₀₀ + \frac{r+l}{r-l} R₂₀ &amp;
\frac{2n}{r-l} R₀₁ + \frac{r+l}{r-l} R₂₁ &amp;
\frac{2n}{r-l} R₀₂ + \frac{r+l}{r-l} R₂₂ &amp;
\frac{2n}{r-l} T₀  + \frac{r+l}{r-l} T₂  &amp;
\\
\frac{2n}{t-b} R₁₀ + \frac{t+b}{t-b} R₂₀ &amp;
\frac{2n}{t-b} R₀₁ + \frac{t+b}{t-b} R₂₁ &amp;
\frac{2n}{t-b} R₀₂ + \frac{t+b}{t-b} R₂₂ &amp;
\frac{2n}{t-b} T₀  + \frac{t+b}{t-b} T₂  &amp;
\\
\frac{f}{f-n} R₂₀ &amp;
\frac{f}{f-n} R₂₁ &amp;
\frac{f}{f-n} R₂₂ &amp;
\frac{f}{f-n} T₂ + \frac{-f n}{f-n}
\\
R₂₀ &amp; R₂₁ &amp; R₂₂ &amp; T₂
\end{bmatrix}
\begin{bmatrix} x \\ y \\ z \\ 1 \end{bmatrix}
\\ &amp;=
\begin{bmatrix}
(\frac{2n}{r-l} R₀₀ + \frac{r+l}{r-l} R₂₀)x +
(\frac{2n}{r-l} R₀₁ + \frac{r+l}{r-l} R₂₁)y +
(\frac{2n}{r-l} R₀₂ + \frac{r+l}{r-l} R₂₂)z +
(\frac{2n}{r-l} T₀  + \frac{r+l}{r-l} T₂ )
\\
(\frac{2n}{t-b} R₁₀ + \frac{t+b}{t-b} R₂₀)x +
(\frac{2n}{t-b} R₀₁ + \frac{t+b}{t-b} R₂₁)y +
(\frac{2n}{t-b} R₀₂ + \frac{t+b}{t-b} R₂₂)z +
(\frac{2n}{t-b} T₀  + \frac{t+b}{t-b} T₂ )
\\
(\frac{f}{f-n} R₂₀)x +
(\frac{f}{f-n} R₂₁)y +
(\frac{f}{f-n} R₂₂)z +
(\frac{f}{f-n} T₂ + \frac{-f n}{f-n})
\\
R₂₀x + R₂₁y + R₂₂z + T₂
\end{bmatrix}
\end{aligned}
$$</p>
<p>Perform perspective division to get the 2D-plane pixel coordinates:</p>
<p>$$
\begin{aligned}
\bm μ &amp;= \frac{1}{μᶜ_w} \bm μᶜ \\
\begin{bmatrix} μ_x \\ μ_y \\ μ_z \\ 1 \end{bmatrix} &amp;=
\begin{bmatrix}
μᶜ_x/μᶜ_w \\ μᶜ_y/μᶜ_w \\ μᶜ_z/μᶜ_w \\ 1
\end{bmatrix} =
\begin{bmatrix}
μᶜ_x/(R₂₀x + R₂₁y + R₂₂z + T₂) \\
μᶜ_y/(R₂₀x + R₂₁y + R₂₂z + T₂) \\
μᶜ_z/(R₂₀x + R₂₁y + R₂₂z + T₂) \\ 1
\end{bmatrix}
\end{aligned}
$$</p>
<ul>
<li>where $(μ_x,\ μ_y)$ are the pixel coordinates, and $μ_z$ is similar to the z in ND space, but ranges in [0,1].
As $μ_z$ doesn&rsquo;t involve into the image formation in 3DGS, it has no contribution to the Loss,
and won&rsquo;t participate the derivative of Loss w.r.t the world coordinates.</li>
</ul>
<p>The derivative of $\bm μ$ w.r.t. $𝐱$:</p>
<p>$$
\begin{aligned}
\frac{∂μ_x}{∂x} &amp;= \frac{(\frac{2n}{r-l} R₀₀ + \frac{r+l}{r-l} R₂₀)(R₂₀x + R₂₁y + R₂₂z + T₂) - μᶜ_x R₂₀
}{(R₂₀x + R₂₁y + R₂₂z + T₂)^2}  \\
&amp;+ \frac{ (\frac{2n}{t-b} R₁₀ + \frac{t+b}{t-b} R₂₀) (R₂₀x + R₂₁y + R₂₂z + T₂) - μᶜ_y R₂₀
}{(R₂₀x + R₂₁y + R₂₂z + T₂)^2}
\end{aligned}
$$</p>
<p>The element indices in the float array <code>proj</code> is column-major:
$\begin{bmatrix} 0 &amp; 4 &amp; 8 &amp; 12 \\ 1 &amp; 5 &amp; 9 &amp; 13 \\ 2 &amp; 6 &amp; 10 &amp; 14 \\ 3 &amp; 7 &amp; 11 &amp; 15 \end{bmatrix}$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">m_w</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_hom</span><span class="p">.</span><span class="n">w</span> <span class="o">+</span> <span class="mf">0.0000001f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dL_dmean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">mul1</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">proj</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">proj</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">proj</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">*</span> <span class="n">m_w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">float</span> <span class="n">mul2</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">proj</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">proj</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">proj</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">*</span> <span class="n">m_w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dmean</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">mul1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">mul2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dmean</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">mul1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="n">mul2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dmean</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="n">mul1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">proj</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">-</span> <span class="n">proj</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">*</span> <span class="n">mul2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dL_dmean2D</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">y</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h4 id="d_rgbd_sh">d_RGB/d_SH</h4>
<hr>
<h4 id="d_cov3dd_m">d_cov3D/d_M</h4>
<p>(2024-02-17)</p>
<p>Goal: Compute the derivative w.r.t. the <strong>entire matrix</strong> 𝐌 (not per element).</p>
<p>Given a quaternion: $q = [r,x,y,z]$, the rotation matrix is:</p>
<p>$$
𝐑 =
\begin{bmatrix}
1 - 2(y² + z²) &amp; 2(xy - rz) &amp; 2(xz + ry) \\
2(xy + rz) &amp; 1 - 2(x² + z²) &amp; 2(yz - rx) \\
2(xz - ry) &amp; 2(yz + rx) &amp; 1 - 2(x²+y²)
\end{bmatrix}
$$</p>
<p>Given a scaling vector $s=[s_x, s_y, s_z]$, the stretching matrix is:</p>
<p>$$
𝐒 =
\begin{bmatrix}
s_x &amp; 0 &amp; 0 \\ 0 &amp; s_y &amp; 0 \\ 0 &amp; 0 &amp; s_z
\end{bmatrix}
$$</p>
<p>The covariance matrix can be decomposed by SVD as:</p>
<p>$$
\bm Σ = 𝐑𝐒𝐒ᵀ𝐑ᵀ
$$</p>
<p>Use 𝐌 to represent 𝐑𝐒:</p>
<p>$$
𝐌 = 𝐑𝐒 \\ =
\begin{bmatrix}
s_x(1 - 2(y² + z²)) &amp; s_y(2(xy - rz))       &amp; s_z(2(xz + ry)) \\
s_x(2(xy + rz))     &amp; s_y(1 - 2(x² + z²))   &amp; s_z(2(yz - rx)) \\
s_x(2(xz - ry))     &amp; s_y(2(yz + rx))       &amp; s_z(1 - 2(x²+y²))
s_x\end{bmatrix}
$$</p>
<p>Therefore, $\bm Σ = 𝐌 𝐌ᵀ$</p>
<p>$$
\bm Σ =
\begin{bmatrix}
m₀₀ &amp; m₀₁ &amp; m₀₂ \\
m₁₀ &amp; m₁₁ &amp; m₁₂ \\
m₂₀ &amp; m₂₁ &amp; m₂₂ \\
\end{bmatrix}
\begin{bmatrix}
m₀₀ &amp; m₁₀ &amp; m₂₀ \\
m₀₁ &amp; m₁₁ &amp; m₂₁ \\
m₀₂ &amp; m₁₂ &amp; m₂₂ \\
\end{bmatrix} = \\
\begin{bmatrix}
m₀₀²+m₀₁²+m₀₂² &amp; m₀₀m₁₀+m₀₁m₁₁+m₀₂m₁₂ &amp; m₀₀m₂₀+m₀₁m₂₁+m₀₂m₂₂ \\
m₁₀m₀₀+m₁₁m₀₁+m₁₂m₀₂ &amp; m₁₀²+m₁₁²+m₁₂² &amp; m₁₀m₂₀+m₁₁m₂₁+m₁₂m₂₂ \\
m₂₀m₀₀+m₂₁m₀₁+m₂₂m₀₂ &amp; m₂₀m₁₀+m₂₁m₁₁+m₂₂m₁₂ &amp; m₂₀²+m₂₁²+m₂₂² \\
\end{bmatrix}
$$</p>
<p>The partial derivative of covariance matrix w.r.t. the element m₀₀:</p>
<p>$$
\frac{∂\bm Σ}{∂m₀₀} =
\begin{bmatrix}
2m₀₀ &amp; m₁₀ &amp; m₂₀ \\ m₁₀ &amp; 0 &amp; 0 \\ m₂₀ &amp; 0 &amp; 0
\end{bmatrix}
$$</p>
<p>The contribution of m₀₀ to the 𝚺 is the summation of all elements.
Similarly, other elements&rsquo; contiribution to d𝚺 are as follows:</p>
<p>$$
\begin{aligned}
\frac{∂\bm Σ}{∂m₀₀} = 2(m₀₀+m₁₀+m₂₀)\ &amp; \frac{∂\bm Σ}{∂m₀₁} = 2(m₀₁+m₁₁+m₂₁) &amp; \frac{∂\bm Σ}{∂m₀₂} = 2(m₀₂+m₁₂+m₂₂) \\
\frac{∂\bm Σ}{∂m₁₀} = 2(m₀₀+m₁₀+m₂₀)\ &amp; \frac{∂\bm Σ}{∂m₁₁} = 2(m₀₁+m₁₁+m₂₁) &amp; \frac{∂\bm Σ}{∂m₁₂} = 2(m₀₂+m₁₂+m₂₂) \\
\frac{∂\bm Σ}{∂m₂₀} = 2(m₀₀+m₁₀+m₂₀)\ &amp; \frac{∂\bm Σ}{∂m₂₁} = 2(m₀₁+m₁₁+m₂₁) &amp; \frac{∂\bm Σ}{∂m₂₂} = 2(m₀₂+m₁₂+m₂₂)
\end{aligned}
$$</p>
<p>$$
\frac{∂\bm Σ}{∂𝐌 } = 2
\begin{bmatrix}
1 &amp; 1 &amp; 1 \\ 1 &amp; 1 &amp; 1 \\ 1 &amp; 1 &amp; 1
\end{bmatrix}
\begin{bmatrix}
m₀₀ &amp; m₀₁ &amp; m₀₂ \\
m₁₀ &amp; m₁₁ &amp; m₁₂ \\
m₂₀ &amp; m₂₁ &amp; m₂₂ \\
\end{bmatrix}
$$</p>
<p>Concat with the upstream coefficient to get the derivative of Loss w.r.t. the <strong>matrix</strong> 𝐌: $\frac{∂L}{∂𝐌 } = \frac{∂L}{∂\bm Σ} \frac{∂\bm Σ}{∂𝐌 }$.</p>
<ul>
<li>
<p>In the code, however, $\frac{∂\bm Σ}{∂𝐌 }$ is on the left:
$\frac{∂L}{∂𝐌 } = \frac{∂\bm Σ}{∂𝐌 } \frac{∂L}{∂\bm Σ}$</p>
</li>
<li>
<p>Because the $\frac{∂L}{∂𝐌 }$ to be solved is a derivative w.r.t. the <strong>entire matrix</strong> 𝐌, not for each element,
the 2 &ldquo;derivative matrices&rdquo; should perform <strong>matrix multiplication</strong> to get all terms mixtured completely,
rather than an elementise product:</p>
</li>
</ul>
<p>$$
\frac{∂L}{∂𝐌 } = \frac{∂\bm Σ}{∂𝐌 } \frac{∂L}{∂\bm Σ} \\
=\begin{bmatrix}
2(m₀₀+m₁₀+m₂₀) &amp; ⋯ &amp; ⋯\\
2(m₀₀+m₁₀+m₂₀) &amp; ⋯ &amp; ⋯\\
⋯ &amp; ⋯ &amp; ⋯
\end{bmatrix}
\begin{bmatrix}
\frac{∂L}{∂v_0} &amp; \frac{∂L}{∂v_1} &amp; \frac{∂L}{∂v_2} \\
\frac{∂L}{∂v_1} &amp; \frac{∂L}{∂v_3} &amp; \frac{∂L}{∂v_4} \\
\frac{∂L}{∂v_2} &amp; \frac{∂L}{∂v_4} &amp; \frac{∂L}{∂v_5}
\end{bmatrix}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">glm</span><span class="o">::</span><span class="n">mat3</span> <span class="n">dL_dM</span> <span class="o">=</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="n">M</span> <span class="o">*</span> <span class="n">dL_dSigma</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>glm performs matrix multiplication according to the <strong>same</strong> rules as in the math textbook,
and the only difference is that the row and column <strong>indices</strong> for an elements are reversed:
<code>mat[col][row]</code> for an element; <code>mat[col]</code> for a column vector.
<ul>
<li><a class="link" href="https://www.opengl-tutorial.org/assets/faq_quaternions/index.html"  target="_blank" rel="noopener"
    >Matrices and Quaternions FAQ - opengl-tutorial</a></li>
<li><a class="link" href="https://www.opengl-tutorial.org/beginners-tutorials/tutorial-3-matrices/"  target="_blank" rel="noopener"
    >Tutorial 3 : Matrices - opengl-tutorial</a></li>
</ul>
</li>
</ul>
<hr>
<h4 id="dmds">dM/ds</h4>
<p>Goal: Compute derivative of loss w.r.t. each <strong>element</strong> in the scaling vector.</p>
<p>In the <a class="link" href="https://github.com/graphdeco-inria/diff-gaussian-rasterization/blob/59f5f77e3ddbac3ed9db93ec2cfe99ed6c5d121d/cuda_rasterizer/backward.cu#L300"  target="_blank" rel="noopener"
    >code</a>,
the 𝐌 =𝐒 𝐑, not 𝐑𝐒,</p>
<p>$$
𝐌 =\begin{bmatrix}
s_x &amp; 0 &amp; 0 \\ 0 &amp; s_y &amp; 0 \\ 0 &amp; 0 &amp; s_z
\end{bmatrix}
\begin{bmatrix}
1 - 2(y² + z²) &amp; 2(xy - rz) &amp; 2(xz + ry) \\
2(xy + rz) &amp; 1 - 2(x² + z²) &amp; 2(yz - rx) \\
2(xz - ry) &amp; 2(yz + rx) &amp; 1 - 2(x²+y²)
\end{bmatrix}  \\
=\begin{bmatrix}
s_x(1 - 2(y² + z²)) &amp; s_x(2(xy - rz))       &amp; s_x(2(xz + ry)) \\
s_y(2(xy + rz))     &amp; s_y(1 - 2(x² + z²))   &amp; s_y(2(yz - rx)) \\
s_z(2(xz - ry))     &amp; s_z(2(yz + rx))       &amp; s_z(1 - 2(x²+y²))
\end{bmatrix}
$$</p>
<p>Calculate the partial derivative of 𝐌 w.r.t. the scaling vector 𝐒 <strong>by element</strong>:</p>
<p>$$
\frac{∂𝐌 }{∂s_x} =
\begin{bmatrix}
1-2(y² + z²) &amp; 2(xy - rz) &amp; 2(xz + ry) \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp;0
\end{bmatrix}
$$</p>
<p>As here it&rsquo;s computing the derivative of the loss w.r.t. <strong>each element</strong>,
the multiplication with the upstream derivative part is an element-wise product:</p>
<p>$$
\frac{∂L}{∂s_x} = \frac{∂L}{∂𝐌 }\frac{∂𝐌 }{∂s_x} = \\
\begin{bmatrix}
s_x(1 - 2(y² + z²)) &amp; s_x(2(xy - rz))       &amp; s_x(2(xz + ry)) \\
⋯                   &amp; ⋯                     &amp; ⋯             \\
⋯                   &amp; ⋯                     &amp; ⋯             \\
\end{bmatrix} ⊙
\begin{bmatrix}
1-2(y² + z²) &amp; 2(xy - rz) &amp; 2(xz + ry) \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp;0
\end{bmatrix}
$$</p>
<p>Because glm indexes elements by columns, to easily access a row in the above 2 matrices, their transposed matrices are used:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">glm</span><span class="o">::</span><span class="n">mat3</span> <span class="n">Rt</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">glm</span><span class="o">::</span><span class="n">mat3</span> <span class="n">dL_dMt</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">transpose</span><span class="p">(</span><span class="n">dL_dM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Gradients of loss w.r.t. scale
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="o">*</span> <span class="n">dL_dscale</span> <span class="o">=</span> <span class="n">dL_dscales</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dscale</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">Rt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dL_dMt</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>	<span class="c1">// scalar
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mat[0] takes out a <strong>column</strong>, as the indices in glm is column-major.
<a class="link" href="http://www.c-jump.com/bcc/common/Talk3/Math/GLM/W01_0090_matrix_columns.htm"  target="_blank" rel="noopener"
    >9. Matrix columns</a></li>
</ul>
<hr>
<h4 id="dmdq">dM/dq</h4>
<p>Goal: Compute derivative of loss w.r.t. each <strong>element</strong> in the quaternion vector (r,x,y,z).</p>
<p>Based on the realtionship:</p>
<p>$$
𝐌 =\begin{bmatrix}
s_x(1 - 2(y² + z²)) &amp; s_x(2(xy - rz))       &amp; s_x(2(xz + ry)) \\
s_y(2(xy + rz))     &amp; s_y(1 - 2(x² + z²))   &amp; s_y(2(yz - rx)) \\
s_z(2(xz - ry))     &amp; s_z(2(yz + rx))       &amp; s_z(1 - 2(x²+y²))
\end{bmatrix}
$$</p>
<p>$$
\frac{∂𝐌 }{∂r} =
\begin{bmatrix}
0 &amp; -2s_x z &amp; 2s_x y \\ 2s_y z &amp; 0 &amp; -2s_y x \\ -2s_z y &amp; 2s_z x &amp; 0
\end{bmatrix}
$$</p>
<p>Concat with the obtained upstream derivative of Loss w.r.t. 𝐌 through element-wise (Hadamard) product:</p>
<p>$$
\frac{∂L}{∂r} = \frac{∂L}{∂𝐌 } \frac{∂𝐌 }{∂r} = \\
\begin{bmatrix}
\frac{∂L}{∂m_{00}} &amp; \frac{∂L}{∂m_{01}} &amp; \frac{∂L}{∂m_{02}} \\
\frac{∂L}{∂m_{10}} &amp; \frac{∂L}{∂m_{11}} &amp; \frac{∂L}{∂m_{12}} \\
\frac{∂L}{∂m_{20}} &amp; \frac{∂L}{∂m_{21}} &amp; \frac{∂L}{∂m_{22}} \\
\end{bmatrix} ⊙
\begin{bmatrix}
0 &amp; -2s_x z &amp; 2s_x y \\ 2s_y z &amp; 0 &amp; -2s_y x \\ -2s_z y &amp; 2s_z x &amp; 0
\end{bmatrix} \\ =
\begin{bmatrix}
0 &amp; \frac{∂L}{∂m_{01}} (-2s_x z) &amp; \frac{∂L}{∂m_{02}} 2s_x y \\
\frac{∂L}{∂m_{10}} 2s_y z &amp; 0 &amp; \frac{∂L}{∂m_{12}} (-2s_y x) \\
\frac{∂L}{∂m_{20}} (-2s_z y) &amp; \frac{∂L}{∂m_{21}} 2s_z x &amp; 0 \\
\end{bmatrix}
$$</p>
<p>$$
$$</p>
<p>Sum all element in the result matrix $\frac{∂L}{∂r}$:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">dL_dMt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">s</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dMt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">s</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dMt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">s</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Gradients of loss w.r.t. normalized quaternion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">glm</span><span class="o">::</span><span class="n">vec4</span> <span class="n">dL_dq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">dL_dq</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="n">dL_dMt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dL_dMt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">dL_dMt</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dL_dMt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl">        <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">dL_dMt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dL_dMt</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>Finally, calculate the derivative of loss for the normalization process of the quaternion.</p>
<p>Based on the normalization operation:</p>
<p>$$
𝐪_{unit} = \frac{1}{‖𝐪‖} ⋅ 𝐪 = \frac{1}{\sqrt{r²+x²+y²+z²}}
\begin{bmatrix} r \\ x \\ y \\ z \end{bmatrix} \\
\frac{∂𝐪}{∂r} = \frac{1}{r²+x²+y²+z²} - \frac{r²}{(r²+x²+y²+z²)^{3/2}}
$$</p>
<p>It seems that the derivatives of the normalization step contributions are not considered in the code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Gradients of loss w.r.t. unnormalized quaternion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">float4</span><span class="o">*</span> <span class="n">dL_drot</span> <span class="o">=</span> <span class="p">(</span><span class="n">float4</span><span class="o">*</span><span class="p">)(</span><span class="n">dL_drots</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">*</span><span class="n">dL_drot</span> <span class="o">=</span> <span class="n">float4</span><span class="p">{</span> <span class="n">dL_dq</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">dL_dq</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">dL_dq</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">dL_dq</span><span class="p">.</span><span class="n">w</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">//dnormvdv(float4{ rot.x, rot.y, rot.z, rot.w }, float4{ dL_dq.x, dL_dq.y, dL_dq.z, dL_dq.w });
</span></span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/splatting/">Splatting</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    

    

    
      
      <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"
              integrity="sha512-EKW5YvKU3hpyyOcN6jQnAxO/L8gts+YdYV6Yymtl8pk9YlYFtqJgihORuRoBXK8/cOIlappdU6Ms8KdK6yBCgA=="
              crossorigin="anonymous" referrerpolicy="no-referrer">
      </script>
    
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pseudocode@2.4.1/build/pseudocode.min.css">
      <script src="https://cdn.jsdelivr.net/npm/pseudocode@2.4.1/build/pseudocode.min.js">
      </script>
    
      
      <script>
        pseudocode.renderClass("pseudocode");
      </script>
    


    
    


    
    

</article>



    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/writenotes/model/splat/b-note-3dgs-math/">
        
        
            <div class="article-image">
                
                    <img src="https://janakiev.com/assets/covariance-matrix_files/covariance_visualization.jpg" loading="lazy" data-key="" data-hash="https://janakiev.com/assets/covariance-matrix_files/covariance_visualization.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">read: 3DGS | Math Derivation</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/writenotes/model/splat/b-note-ewa_splatting/">
        
        
            <div class="article-image">
                
                    <img src="https://pic2.zhimg.com/80/v2-7cbe3b0c3b67ce80593fad0d73a814b5_720w.webp" loading="lazy" data-key="" data-hash="https://pic2.zhimg.com/80/v2-7cbe3b0c3b67ce80593fad0d73a814b5_720w.webp"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">read: EWA Splatting</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/writenotes/model/splat/d-vid-3dgs-explain-%E8%91%B5/">
        
        
            <div class="article-image">
                
                    <img src="https://img.youtube.com/vi/1buFrKUaqwM/maxresdefault.jpg" loading="lazy" data-key="" data-hash="https://img.youtube.com/vi/1buFrKUaqwM/maxresdefault.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">watch: 3DGS | AI葵 Cuda Code Walkthrough</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/writenotes/model/splat/b-note-3dgs-read/">
        
        
            <div class="article-image">
                
                    <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Ftse3.mm.bing.net%2Fth%3Fid%3DOIP.bfDD9_L28UK7AsADDzB8vwHaEo%26pid%3DApi&amp;f=1&amp;ipt=3b34b7952e1e03305e5c085185ede1ad09e8edc71e9c1161a33c17b6b9f2b3ac&amp;ipo=images" loading="lazy" data-key="" data-hash="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Ftse3.mm.bing.net%2Fth%3Fid%3DOIP.bfDD9_L28UK7AsADDzB8vwHaEo%26pid%3DApi&amp;f=1&amp;ipt=3b34b7952e1e03305e5c085185ede1ad09e8edc71e9c1161a33c17b6b9f2b3ac&amp;ipo=images"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">read: NVS - 3D Gaussian Splatting</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Zichen Wang
    </section>
    
    <section class="powerby">
        
              <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>
   <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
